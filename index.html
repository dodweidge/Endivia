<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <!-- 让网页自己处理缩放/拖动：禁用浏览器默认双指缩放 -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Macintosh (System 1) Mock · Mobile Pinch/Pan + PC Drag</title>
  <style>
    :root{
      --stageW: 900;
      --stageH: 640;

      /* baseFit(自动适配) * userZoom(用户缩放) = --fit */
      --fit: 1;

      --scale: 1.0;
      --ui: 12px;
      --barH: calc(22px * var(--scale));
      --winBorder: 2px;

      --bw:#000;
      --paper:#fff;
      --desk1:#e9e9e9;
      --desk2:#d9d9d9;
      --shadow: rgba(0,0,0,.35);
      --sel:#000;
      --selText:#fff;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    html, body{
      margin:0;
      overflow:hidden;
      overscroll-behavior:none;

      /* 关键：我们用 Pointer Events 自己实现双指缩放/拖动 */
      touch-action:none;

      -webkit-user-select:none;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    body{
      background:
        radial-gradient(1200px 800px at 50% 40%, rgba(255,255,255,.12), transparent 55%),
        radial-gradient(900px 600px at 20% 70%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.18), transparent 20%, transparent 80%, rgba(0,0,0,.35)),
        repeating-linear-gradient(45deg, rgba(255,255,255,.06) 0 6px, rgba(0,0,0,.04) 6px 12px),
        radial-gradient(circle, rgba(0,0,0,.14) 1px, transparent 1px);
      background-size:auto,auto,auto,auto,6px 6px;

      font-family:"MS Gothic","SimSun",ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
      -webkit-font-smoothing:none;
      -moz-osx-font-smoothing:auto;
      text-rendering: optimizeSpeed;
      color:#fff;
    }

    /* 视口容器：居中显示 */
    .center{
      position:fixed; inset:0;
      display:grid; place-items:center;
      padding: max(8px, env(safe-area-inset-top)) max(8px, env(safe-area-inset-right))
               max(8px, env(safe-area-inset-bottom)) max(8px, env(safe-area-inset-left));
      touch-action:none;
    }

    /* stageWrap：承载“平移”；宽高等于缩放后的可见尺寸 */
    .stageWrap{
      width: calc(var(--stageW) * 1px * var(--fit));
      height: calc(var(--stageH) * 1px * var(--fit));
      will-change: transform;
      filter:
        drop-shadow(0 26px 0 rgba(0,0,0,.35))
        drop-shadow(0 18px 38px rgba(0,0,0,.35));
      touch-action:none;
    }

    /* stage：承载“缩放”——避免移动端 transform 造成布局裁切 */
    .stage{
      width: calc(var(--stageW) * 1px);
      height: calc(var(--stageH) * 1px);
      position:relative;
      overflow:hidden;
      border:5px solid #000;
      background:#fff;
      filter:contrast(1.06);

      transform: scale(var(--fit));
      transform-origin: top left;
      touch-action:none;
    }

    .stage::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(to bottom, rgba(0,0,0,.07) 0 1px, transparent 1px 3px),
        radial-gradient(circle, rgba(0,0,0,.12) 1px, transparent 1px),
        radial-gradient(900px 600px at 50% 45%, rgba(0,0,0,.20), transparent 60%);
      background-size:auto,4px 4px,auto;
      opacity:.55;
      mix-blend-mode:multiply;
    }

    .ui{
      position:absolute; inset:0;
      background: repeating-linear-gradient(45deg, var(--desk1) 0 2px, var(--desk2) 2px 4px);
      color:#000;
      touch-action:none;
    }
    .ui::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle, rgba(0,0,0,.10) 1px, transparent 1px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.04) 0 1px, transparent 1px 6px);
      background-size:6px 6px,7px 7px;
      opacity:.16;
      mix-blend-mode:multiply;
    }

    /* Menu bar */
    .menubar{
      position:absolute; left:0; right:0; top:0;
      height: var(--barH);
      background: var(--paper);
      border-bottom: var(--winBorder) solid var(--bw);
      display:flex;
      align-items:center;
      padding: 0 calc(8px * var(--scale));
      gap: calc(10px * var(--scale));
      z-index: 9999;
      font-size: calc(var(--ui) * var(--scale));
      line-height:1;
      touch-action:none;
    }
    .menu-left,.menu-right{ display:flex; align-items:center; gap: calc(10px * var(--scale)); }
    .menu-right{ margin-left:auto; gap: calc(12px * var(--scale)); }
    .apple{
      width: calc(16px * var(--scale));
      height: calc(16px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      display:grid; place-items:center;
      font-weight:700;
      font-size: calc(12px * var(--scale));
      cursor:pointer;
      background:transparent;
      touch-action:none;
    }
    .menu-item{
      padding: calc(3px * var(--scale)) calc(6px * var(--scale));
      cursor:pointer;
      border:1px solid transparent;
      touch-action:none;
    }
    .menu-item.active{ background: var(--bw); color: var(--paper); }

    /* Dropdown */
    .dropdown{
      position:absolute;
      top: calc(var(--barH) - 1px);
      min-width: calc(240px * var(--scale));
      background: var(--paper);
      border: var(--winBorder) solid var(--bw);
      box-shadow: 0 calc(8px * var(--scale)) 0 var(--shadow);
      display:none;
      z-index:9998;
      font-size: calc(var(--ui) * var(--scale));
      touch-action:none;
    }
    .dropdown .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: calc(8px * var(--scale)) calc(12px * var(--scale));
      border-bottom: 1px solid rgba(0,0,0,.2);
      cursor:pointer;
      touch-action:none;
    }
    .dropdown .row:last-child{ border-bottom:0; }
    .dropdown .row:hover{ background: var(--bw); color: var(--paper); }
    .kbd{ opacity:.75; margin-left: calc(12px * var(--scale)); }
    .muted{ opacity:.7; }

    /* Desktop */
    .desktop{
      position:absolute;
      left:0; right:0;
      top: var(--barH);
      bottom:0;
      padding: calc(14px * var(--scale));
      touch-action:none;
    }

    /* Icons */
    .icon{
      position:absolute;
      width: calc(76px * var(--scale));
      text-align:center;
      cursor: default;
      touch-action:none;
    }
    .icon .glyph{
      width: calc(36px * var(--scale));
      height: calc(36px * var(--scale));
      margin: 0 auto calc(6px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
      display:grid; place-items:center;
      touch-action:none;
    }
    .icon .label{
      display:inline-block;
      padding: calc(2px * var(--scale)) calc(4px * var(--scale));
      font-size: calc(var(--ui) * var(--scale));
      line-height:1.15;
      background:transparent;
      color:var(--bw);
      touch-action:none;
    }
    .icon.selected .label{ background: var(--sel); color: var(--selText); }

    /* Windows */
    .window{
      position:absolute;
      background: var(--paper);
      border: var(--winBorder) solid var(--bw);
      box-shadow: 0 calc(10px * var(--scale)) 0 var(--shadow);
      min-width: calc(240px * var(--scale));
      min-height: calc(130px * var(--scale));
      display:none;
      touch-action:none;
    }
    .window.visible{ display:block; }
    .window.inactive{ opacity:.95; }

    .titlebar{
      height: calc(22px * var(--scale));
      border-bottom: var(--winBorder) solid var(--bw);
      display:flex;
      align-items:center;
      gap: calc(8px * var(--scale));
      padding: 0 calc(8px * var(--scale));
      cursor: move;
      background: repeating-linear-gradient(90deg, transparent 0 6px, rgba(0,0,0,.14) 6px 7px);
      touch-action:none;
    }
    .closebox{
      width: calc(16px * var(--scale));
      height: calc(16px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
      cursor:pointer;
      flex:0 0 auto;
      display:grid; place-items:center;
      font-size: calc(12px * var(--scale));
      line-height:1;
      touch-action:none;
    }
    .wintitle{
      flex:1 1 auto;
      text-align:center;
      font-size: calc(var(--ui) * var(--scale));
      letter-spacing:.02em;
      font-weight:700;
      padding-right: calc(18px * var(--scale));
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .content{
      position:relative;
      padding: calc(10px * var(--scale));
      font-size: calc(var(--ui) * var(--scale));
      line-height:1.35;
    }

    .resize-handle{
      position:absolute;
      right: 2px;
      bottom: 2px;
      width: calc(16px * var(--scale));
      height: calc(16px * var(--scale));
      border-left: var(--winBorder) solid var(--bw);
      border-top: var(--winBorder) solid var(--bw);
      background: repeating-linear-gradient(135deg, transparent 0 3px, rgba(0,0,0,.22) 3px 4px);
      cursor:nwse-resize;
      touch-action:none;
    }

    .scrollframe{
      display:grid;
      grid-template-columns: 1fr calc(16px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
      height: calc(220px * var(--scale));
    }
    .scrollframe .pane{
      padding: calc(10px * var(--scale));
      overflow:auto;
      user-select:text;
      -webkit-user-select:text;
      touch-action: pan-y; /* allow inner scroll */
    }
    .scrollframe .bar{
      border-left: var(--winBorder) solid var(--bw);
      background: repeating-linear-gradient(45deg, #fff 0 2px, #eee 2px 4px);
      position:relative;
    }
    .scrollframe .thumb{
      position:absolute;
      left:2px; right:2px;
      top: calc(22px * var(--scale));
      height: calc(44px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
    }

    .list{
      border: var(--winBorder) solid var(--bw);
      padding: calc(8px * var(--scale));
      background: var(--paper);
    }
    .list .item{
      display:flex;
      justify-content:space-between;
      padding: calc(6px * var(--scale)) calc(8px * var(--scale));
      cursor:default;
      touch-action:none;
    }
    .list .item:hover{ background: var(--bw); color: var(--paper); }

    .dialog{ width: calc(420px * var(--scale)); }
    .btnrow{
      display:flex;
      justify-content:flex-end;
      gap: calc(8px * var(--scale));
      margin-top: calc(10px * var(--scale));
    }
    .btn{
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
      padding: calc(8px * var(--scale)) calc(12px * var(--scale));
      cursor:pointer;
      font-size: calc(var(--ui) * var(--scale));
      touch-action:none;
    }
    .btn:active{ transform: translateY(1px); }

    /* Calculator */
    .calc{ display:grid; gap: calc(10px * var(--scale)); }
    .calc-display{
      border: var(--winBorder) solid var(--bw);
      background:#fff;
      padding: calc(8px * var(--scale)) calc(10px * var(--scale));
      font-size: calc(18px * var(--scale));
      font-weight:700;
      text-align:right;
      height: calc(36px * var(--scale));
      display:flex;
      align-items:center;
      justify-content:flex-end;
      overflow:hidden;
      user-select:text;
      -webkit-user-select:text;
    }
    .calc-keys{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: calc(6px * var(--scale));
    }
    .key{
      border: var(--winBorder) solid var(--bw);
      background:#fff;
      padding: calc(12px * var(--scale)) 0;
      font-size: calc(13px * var(--scale));
      cursor:pointer;
      text-align:center;
      user-select:none;
      touch-action:none;
    }
    .key:active{ transform: translateY(1px); }
    .key.wide{ grid-column: span 2; }
    .key.op{ font-weight:700; }

    /* Music */
    .player{ display:grid; gap: calc(10px * var(--scale)); }
    .player-head{
      border: var(--winBorder) solid var(--bw);
      padding: calc(8px * var(--scale));
      background:#fff;
      display:grid;
      gap: calc(6px * var(--scale));
    }
    .trackline{
      display:flex;
      justify-content:space-between;
      gap: calc(10px * var(--scale));
      align-items:center;
      font-weight:700;
    }
    .trackline .name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .time{
      display:flex;
      justify-content:space-between;
      font-size: calc(11px * var(--scale));
    }
    .controls{
      display:flex;
      gap: calc(8px * var(--scale));
      align-items:center;
    }
    .range{
      width:100%;
      -webkit-appearance:none;
      appearance:none;
      height: calc(18px * var(--scale));
      background:#fff;
      border: var(--winBorder) solid var(--bw);
      outline:none;
      margin:0;
      touch-action: pan-x;
    }
    .range::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width: calc(14px * var(--scale));
      height: calc(20px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      background:#fff;
      cursor:pointer;
    }
    .player-note{ font-size: calc(11px * var(--scale)); }

    .outerTip{
      position:fixed;
      left:12px; right:12px;
      bottom:10px;
      font-size:12px;
      opacity:.88;
      color: rgba(255,255,255,.88);
      text-shadow: 0 2px 0 rgba(0,0,0,.55);
      pointer-events:none;
    }
    .outerTip code{
      background: rgba(0,0,0,.45);
      padding: 2px 6px;
      border-radius:6px;
      border: 1px solid rgba(255,255,255,.20);
    }

    body.big .ui{ --scale: 1.25; }
    body.huge .ui{ --scale: 1.55; }
  </style>
</head>

<body>
  <div class="center" id="center">
    <div class="stageWrap" id="stageWrap">
      <div class="stage" id="stage">
        <div class="ui" id="ui">

          <div class="menubar" id="menubar">
            <div class="menu-left">
              <div class="apple" id="appleBtn" title=""></div>
              <div class="menu-item" data-menu="file">File</div>
              <div class="menu-item" data-menu="edit">Edit</div>
              <div class="menu-item" data-menu="view">View</div>
              <div class="menu-item" data-menu="special">Special</div>
            </div>
            <div class="menu-right">
              <div class="muted" id="clock">--:--</div>
            </div>
          </div>

          <div class="dropdown" id="dd-apple">
            <div class="row" data-action="about">About the Macintosh…</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="openFinder">Open Finder</div>
            <div class="row" data-action="openNote">Open Note Pad</div>
            <div class="row" data-action="openCalc">Open Calculator</div>
            <div class="row" data-action="openMusic">Open Music Player</div>
            <div class="row" data-action="openOrbitMap">Open Orbit Map</div>
          </div>

          <div class="dropdown" id="dd-file">
            <div class="row" data-action="openFinder">Open</div>
            <div class="row" data-action="openNote">New Note</div>
            <div class="row" data-action="openCalc">Open Calculator</div>
            <div class="row" data-action="openMusic">Open Music Player</div>
            <div class="row" data-action="openOrbitMap">Open Orbit Map</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="closeFront">Close <span class="kbd">⌘W</span></div>
          </div>

          <div class="dropdown" id="dd-edit">
            <div class="row" data-action="beep">Undo <span class="kbd">⌘Z</span></div>
            <div class="row" data-action="beep">Cut <span class="kbd">⌘X</span></div>
            <div class="row" data-action="beep">Copy <span class="kbd">⌘C</span></div>
            <div class="row" data-action="beep">Paste <span class="kbd">⌘V</span></div>
          </div>

          <div class="dropdown" id="dd-view">
            <div class="row" data-action="scaleNormal">Normal UI</div>
            <div class="row" data-action="scaleBig">Big UI</div>
            <div class="row" data-action="scaleHuge">Huge UI</div>
          </div>

          <div class="dropdown" id="dd-special">
            <div class="row" data-action="cleanup">Clean Up Desktop</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="recenter">Re-center View</div>
          </div>

          <div class="desktop" id="desktop">
            <div class="icon" id="icon-hd" data-open="finder" style="left:24px; top:24px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="6" y="6" width="24" height="24" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="10" width="16" height="8" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="22" width="16" height="6" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="13" y="24" width="3" height="2" fill="#000"/>
                  <rect x="20" y="24" width="3" height="2" fill="#000"/>
                </svg>
              </div>
              <div class="label">Macintosh HD</div>
            </div>

            <div class="icon" id="icon-note" data-open="note" style="left:24px; top:122px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="8" y="6" width="20" height="24" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="10" width="16" height="2" fill="#000"/>
                  <rect x="10" y="14" width="16" height="2" fill="#000"/>
                  <rect x="10" y="18" width="12" height="2" fill="#000"/>
                  <rect x="10" y="22" width="14" height="2" fill="#000"/>
                </svg>
              </div>
              <div class="label">Note Pad</div>
            </div>

            <div class="icon" id="icon-calc" data-open="calc" style="left:24px; top:220px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="9" y="6" width="18" height="24" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="11" y="9" width="14" height="6" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="11" y="18" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="16" y="18" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="21" y="18" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="11" y="23" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="16" y="23" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="21" y="23" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                </svg>
              </div>
              <div class="label">Calculator</div>
            </div>

            <div class="icon" id="icon-music" data-open="music" style="left:24px; top:318px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="8" y="7" width="20" height="22" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="12" y="11" width="10" height="2" fill="#000"/>
                  <rect x="12" y="15" width="14" height="2" fill="#000"/>
                  <rect x="12" y="19" width="12" height="2" fill="#000"/>
                  <rect x="12" y="23" width="8"  height="2" fill="#000"/>
                  <circle cx="24" cy="24" r="2" fill="#000"/>
                  <rect x="25" y="12" width="2" height="12" fill="#000"/>
                </svg>
              </div>
              <div class="label">Music</div>
            </div>


            <div class="icon" id="icon-endivia" data-open="endivia" style="left:24px; top:416px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges" aria-hidden="true">
  <!-- ring -->
  <circle cx="18" cy="18" r="11" fill="#fff" stroke="#000" stroke-width="2"/>
  <circle cx="18" cy="18" r="6" fill="#fff" stroke="#000" stroke-width="2"/>
  <!-- central spine -->
  <rect x="16" y="7" width="4" height="22" fill="#fff" stroke="#000" stroke-width="2"/>
  <!-- side modules -->
  <rect x="6"  y="15" width="6" height="6" fill="#fff" stroke="#000" stroke-width="2"/>
  <rect x="24" y="15" width="6" height="6" fill="#fff" stroke="#000" stroke-width="2"/>
  <!-- tiny ports -->
  <rect x="17" y="10" width="2" height="2" fill="#000"/>
  <rect x="17" y="24" width="2" height="2" fill="#000"/>
</svg>
              </div>
              <div class="label">Endivia</div>
            </div>

            <div class="icon" id="icon-orbitmap" data-open="orbitmap" style="left:24px; top:514px;">
              <div class="glyph" aria-hidden="true">
                <!-- pixel-ish Earth + terminator + station -->
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="7" y="7" width="22" height="22" fill="#fff" stroke="#000" stroke-width="2"/>
                  <circle cx="18" cy="18" r="8" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="18" y="10" width="1" height="16" fill="#000"/>
                  <circle cx="24" cy="14" r="1.5" fill="#000"/>
                  <rect x="24" y="13" width="6" height="2" fill="#000"/>
                  <rect x="30" y="12" width="1" height="4" fill="#000"/>
                </svg>
              </div>
              <div class="label">Orbit Map</div>
            </div>


            <div class="icon" id="icon-trash" data-open="trash" style="left:792px; top:24px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="12" y="10" width="12" height="20" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="10" width="16" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="14" y="14" width="2" height="14" fill="#000"/>
                  <rect x="20" y="14" width="2" height="14" fill="#000"/>
                </svg>
              </div>
              <div class="label">Trash</div>
            </div>
          </div>

          <div class="window visible" id="win-finder" style="left:140px; top:80px; width:540px; height:360px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-finder">×</div>
              <div class="wintitle">Finder</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="scrollframe" style="height: calc(100% - 2px);">
                <div class="pane">
                  <div class="muted">Macintosh HD</div>
                  <div style="height:8px"></div>
                  <div class="list" id="finderList">
                    <div class="item" data-open="note"><span>Note Pad</span><span class="muted">Application</span></div>
                    <div class="item" data-open="calc"><span>Calculator</span><span class="muted">Application</span></div>
                    <div class="item" data-open="music"><span>Music Player</span><span class="muted">Application</span></div>
                    <div class="item" data-open="endivia"><span>Endivia Hotel</span><span class="muted">Website</span></div>
                    <div class="item" data-open="orbitmap"><span>Orbit Map</span><span class="muted">Application</span></div>
                    <div class="item" data-open="about"><span>Read Me</span><span class="muted">Text</span></div>
                  </div>
                  <div style="height:12px"></div>
                  <div class="muted">手机：双指缩放/拖动视图 · 单指拖动图标/窗口</div>
                </div>
                <div class="bar" aria-hidden="true"><div class="thumb"></div></div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-finder" title="Resize"></div>
          </div>

          <div class="window" id="win-note" style="left:220px; top:140px; width:520px; height:360px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-note">×</div>
              <div class="wintitle" id="noteTitle">Note Pad</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="scrollframe" style="height: calc(100% - 2px);">
                <div class="pane" style="padding:0; overflow:hidden; touch-action: pan-y;">
                  <textarea id="noteArea" style="
                    width:100%; height:100%;
                    border:0; outline:none;
                    padding: calc(10px * var(--scale));
                    resize:none;
                    font: inherit;
                    font-size: calc(var(--ui) * var(--scale));
                    line-height:1.45;
                    background: transparent;
                    color:#000;
                    touch-action: pan-y;
                    -webkit-user-select:text;
                    user-select:text;
                  ">✅ 现在不会再把你缩放后的视图强制回正。

提示：
- 双指缩放：缩放整个“屏幕”
- 双指拖动：平移视图
- Special → Re-center View：手动回到初始居中适配</textarea>
                </div>
                <div class="bar" aria-hidden="true"><div class="thumb"></div></div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-note" title="Resize"></div>
          </div>

          <div class="window" id="win-calc" style="left:540px; top:140px; width:300px; height:360px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-calc">×</div>
              <div class="wintitle">Calculator</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="calc" style="height:100%;">
                <div class="calc-display" id="calcDisplay">0</div>
                <div class="calc-keys">
                  <div class="key" data-k="C">C</div>
                  <div class="key" data-k="BS">⌫</div>
                  <div class="key" data-k="%">%</div>
                  <div class="key op" data-k="/">÷</div>

                  <div class="key" data-k="7">7</div>
                  <div class="key" data-k="8">8</div>
                  <div class="key" data-k="9">9</div>
                  <div class="key op" data-k="*">×</div>

                  <div class="key" data-k="4">4</div>
                  <div class="key" data-k="5">5</div>
                  <div class="key" data-k="6">6</div>
                  <div class="key op" data-k="-">−</div>

                  <div class="key" data-k="1">1</div>
                  <div class="key" data-k="2">2</div>
                  <div class="key" data-k="3">3</div>
                  <div class="key op" data-k="+">+</div>

                  <div class="key wide" data-k="0">0</div>
                  <div class="key" data-k=".">.</div>
                  <div class="key op" data-k="=">=</div>
                </div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-calc" title="Resize"></div>
          </div>

          <div class="window" id="win-music" style="left:420px; top:220px; width:420px; height:260px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-music">×</div>
              <div class="wintitle">Music Player</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="player" style="height:100%;">
                <div class="player-head">
                  <div class="trackline">
                    <div class="name" id="musicName">song.mp3</div>
                    <div class="state" id="musicState">STOP</div>
                  </div>
                  <div class="time">
                    <div id="musicTime">0:00</div>
                    <div id="musicDur">0:00</div>
                  </div>
                  <input class="range" id="musicSeek" type="range" min="0" max="0" step="0.01" value="0" />
                </div>

                <div class="controls">
                  <button class="btn" id="musicPlay">Play</button>
                  <button class="btn" id="musicPause">Pause</button>
                  <div class="muted" style="margin-left:auto;" id="musicStatus">Ready</div>
                </div>

                <div class="player-note muted">
                  把 <b>song.mp3</b> 放在与本 HTML 同目录。
                </div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-music" title="Resize"></div>
          </div>


          <div class="window" id="win-endivia" style="left:170px; top:110px; width:620px; height:420px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-endivia">×</div>
              <div class="wintitle">Endivia · Orbital Hotel</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale))); padding:0;">
              <div class="scrollframe" style="height: 100%; border:0; grid-template-columns: 1fr calc(16px * var(--scale));">
                <div class="pane" style="padding: calc(10px * var(--scale)); touch-action: pan-y;">
                  <div style="border: var(--winBorder) solid #000; padding: calc(10px * var(--scale)); background:#fff;">
                    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap: calc(10px * var(--scale));">
                      <div>
                        <div style="font-size: calc(18px * var(--scale)); font-weight:700; line-height:1.1;">ENDIVIA</div>
                        <div class="muted" style="margin-top: calc(4px * var(--scale));">
                          Orbital Hotel · Dock A / Ring 3
                        </div>
                      </div>
                      <div style="text-align:right;">
                        <div style="font-weight:700;">Position</div>
                        <div class="muted">
                          Altitude: <b>412 km</b><br/>
                          Inclination: <b>51.6°</b>
                        </div>
                      </div>
                    </div>

                    <div style="height: calc(10px * var(--scale));"></div>

                    <div style="display:flex; gap: calc(8px * var(--scale)); flex-wrap:wrap;">
                      <button class="btn" data-endivia-tab="rooms">Rooms</button>
                      <button class="btn" data-endivia-tab="about">About</button>
                      <button class="btn" data-endivia-tab="orbit">Orbit</button>
                      <button class="btn" data-endivia-tab="contact">Contact</button>
                      <div style="margin-left:auto; display:flex; gap: calc(8px * var(--scale)); align-items:center;">
                        <span class="muted">Status:</span>
                        <span style="border: var(--winBorder) solid #000; padding: 2px 8px; background:#fff; font-weight:700;">DOCKED</span>
                      </div>
                    </div>
                  </div>

                  <div style="height: calc(10px * var(--scale));"></div>

                  <div id="endiviaPage">

                    <section data-endivia-page="rooms">
                      <div style="font-weight:700; font-size: calc(14px * var(--scale));">Featured Rooms</div>
                      <div class="muted" style="margin: calc(6px * var(--scale)) 0 calc(10px * var(--scale));">
                        All rooms include vacuum-rated viewports, radiation-shielded sleep pods, and station-wide mesh uplink.
                      </div>

                      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: calc(10px * var(--scale));">
                        <div style="border: var(--winBorder) solid #000; background:#fff;">
                          <div style="border-bottom: var(--winBorder) solid #000; padding: calc(8px * var(--scale)); font-weight:700;">
                            Capsule Classic
                          </div>
                          <div style="padding: calc(8px * var(--scale));">
                            <div class="muted">Single · Quiet deck</div>
                            <ul style="margin: calc(6px * var(--scale)) 0 0; padding-left: 18px;">
                              <li>1 sleep pod + privacy curtain</li>
                              <li>Shared hygiene bay access</li>
                              <li>Viewport “star-slit”</li>
                            </ul>
                            <div style="height: calc(8px * var(--scale));"></div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                              <span style="font-weight:700;">₡ 120 / night</span>
                              <button class="btn" data-endivia-book="Capsule Classic">Book</button>
                            </div>
                          </div>
                        </div>

                        <div style="border: var(--winBorder) solid #000; background:#fff;">
                          <div style="border-bottom: var(--winBorder) solid #000; padding: calc(8px * var(--scale)); font-weight:700;">
                            Vista Suite
                          </div>
                          <div style="padding: calc(8px * var(--scale));">
                            <div class="muted">Double · Earth-facing</div>
                            <ul style="margin: calc(6px * var(--scale)) 0 0; padding-left: 18px;">
                              <li>Panoramic viewport</li>
                              <li>Private hygiene module</li>
                              <li>Micro-gravity lounge</li>
                            </ul>
                            <div style="height: calc(8px * var(--scale));"></div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                              <span style="font-weight:700;">₡ 320 / night</span>
                              <button class="btn" data-endivia-book="Vista Suite">Book</button>
                            </div>
                          </div>
                        </div>

                        <div style="border: var(--winBorder) solid #000; background:#fff;">
                          <div style="border-bottom: var(--winBorder) solid #000; padding: calc(8px * var(--scale)); font-weight:700;">
                            Garden Atrium Loft
                          </div>
                          <div style="padding: calc(8px * var(--scale));">
                            <div class="muted">Double · Ring 3 greenhouse</div>
                            <ul style="margin: calc(6px * var(--scale)) 0 0; padding-left: 18px;">
                              <li>Hydroponic aroma zone</li>
                              <li>Low-noise air circulation</li>
                              <li>Tea service “Endive Blend”</li>
                            </ul>
                            <div style="height: calc(8px * var(--scale));"></div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                              <span style="font-weight:700;">₡ 260 / night</span>
                              <button class="btn" data-endivia-book="Garden Atrium Loft">Book</button>
                            </div>
                          </div>
                        </div>

                        <div style="border: var(--winBorder) solid #000; background:#fff;">
                          <div style="border-bottom: var(--winBorder) solid #000; padding: calc(8px * var(--scale)); font-weight:700;">
                            Commander’s Corner
                          </div>
                          <div style="padding: calc(8px * var(--scale));">
                            <div class="muted">Single · Dock-adjacent</div>
                            <ul style="margin: calc(6px * var(--scale)) 0 0; padding-left: 18px;">
                              <li>Fast egress path</li>
                              <li>Hard-mount luggage rack</li>
                              <li>Station briefing feed</li>
                            </ul>
                            <div style="height: calc(8px * var(--scale));"></div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                              <span style="font-weight:700;">₡ 180 / night</span>
                              <button class="btn" data-endivia-book="Commander’s Corner">Book</button>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div style="height: calc(12px * var(--scale));"></div>
                      <div style="border: var(--winBorder) solid #000; background:#fff; padding: calc(10px * var(--scale));">
                        <div style="font-weight:700;">Amenities</div>
                        <div class="muted" style="margin-top: calc(6px * var(--scale));">
                          Spin-gravity shower stalls · Cupola lounge reservations · EVA photo deck (guided) ·
                          24/7 galley with “crumb-safe” pastry options
                        </div>
                      </div>
                    </section>

                    <section data-endivia-page="about" style="display:none;">
                      <div style="font-weight:700; font-size: calc(14px * var(--scale));">About Endivia</div>
                      <div style="height: calc(8px * var(--scale));"></div>
                      <div style="border: var(--winBorder) solid #000; background:#fff; padding: calc(10px * var(--scale));">
                        <p style="margin:0;">
                          <b>Endivia</b> is a boutique hotel embedded within a working space station. We’re built for
                          travelers who want the romance of orbit without the chaos of a full expedition.
                        </p>
                        <div style="height: calc(10px * var(--scale));"></div>
                        <div class="muted">
                          Signature experience: a “night pass” to the cupola during orbital dawn, with a guided view of
                          the terminator line sweeping across Earth.
                        </div>
                      </div>

                      <div style="height: calc(10px * var(--scale));"></div>
                      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: calc(10px * var(--scale));">
                        <div style="border: var(--winBorder) solid #000; background:#fff; padding: calc(10px * var(--scale));">
                          <div style="font-weight:700;">Check-in</div>
                          <div class="muted" style="margin-top: calc(6px * var(--scale));">
                            Decompression briefing · Suit lock training · Mesh credential issuance
                          </div>
                        </div>
                        <div style="border: var(--winBorder) solid #000; background:#fff; padding: calc(10px * var(--scale));">
                          <div style="font-weight:700;">Dining</div>
                          <div class="muted" style="margin-top: calc(6px * var(--scale));">
                            Endive Blend tea · “No-crumb” croissants · Fresh greens from Ring 3
                          </div>
                        </div>
                      </div>
                    </section>

                    <section data-endivia-page="orbit" style="display:none;">
                      <div style="font-weight:700; font-size: calc(14px * var(--scale));">Orbit Details</div>
                      <div style="height: calc(8px * var(--scale));"></div>

                      <div style="border: var(--winBorder) solid #000; background:#fff; padding: calc(10px * var(--scale));">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: calc(10px * var(--scale));">
                          <div>
                            <div style="font-weight:700;">Altitude</div>
                            <div class="muted">412 km (mean)</div>
                          </div>
                          <div>
                            <div style="font-weight:700;">Inclination</div>
                            <div class="muted">51.6°</div>
                          </div>
                          <div>
                            <div style="font-weight:700;">Period</div>
                            <div class="muted">~92 minutes</div>
                          </div>
                          <div>
                            <div style="font-weight:700;">Local “Day”</div>
                            <div class="muted">16 sunrises / 24h</div>
                          </div>
                        </div>

                        <div style="height: calc(10px * var(--scale));"></div>
                        <div class="muted">
                          For safety and privacy, Endivia publishes location in orbital elements instead of ground address.
                          Docking windows vary by station traffic and attitude control schedules.
                        </div>
                      </div>
                    </section>

                    <section data-endivia-page="contact" style="display:none;">
                      <div style="font-weight:700; font-size: calc(14px * var(--scale));">Contact</div>
                      <div style="height: calc(8px * var(--scale));"></div>

                      <div style="border: var(--winBorder) solid #000; background:#fff; padding: calc(10px * var(--scale));">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: calc(10px * var(--scale));">
                          <div>
                            <div style="font-weight:700;">Relay</div>
                            <div class="muted">ENDIVIA-OPS / Channel 7</div>
                          </div>
                          <div>
                            <div style="font-weight:700;">Dock</div>
                            <div class="muted">Dock A · Airlock 2</div>
                          </div>
                        </div>
                        <div style="height: calc(10px * var(--scale));"></div>
                        <div class="muted">
                          For bookings, tap a room’s “Book” button. (Fictional demo site inside the mock system.)
                        </div>
                      </div>
                    </section>

                  </div>
                </div>
                <div class="bar" aria-hidden="true"><div class="thumb"></div></div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-endivia" title="Resize"></div>
          </div>

          
          <div class="window" id="win-orbitmap" style="left:210px; top:120px; width:620px; height:420px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-orbitmap">×</div>
              <div class="wintitle">Orbit Map · Day/Night + Ground Track</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div style="border: var(--winBorder) solid #000; background:#fff; padding: calc(8px * var(--scale));">
                <div style="display:flex; gap: calc(10px * var(--scale)); align-items:center; flex-wrap:wrap;">
                  <div style="font-weight:700;">Live Earth</div>
                  <div class="muted" id="orbitMapTime">--</div>
                  <div style="margin-left:auto; display:flex; gap: calc(8px * var(--scale));">
                    <button class="btn" id="orbitMapRecenter">Recenter</button>
                    <button class="btn" id="orbitMapTrail">Trail: ON</button>
                  </div>
                </div>
              </div>

              <div style="height: calc(8px * var(--scale));"></div>

              <div style="border: var(--winBorder) solid #000; background:#fff; padding: calc(8px * var(--scale)); height: calc(100% - (60px * var(--scale)));">
                <canvas id="orbitCanvas" width="960" height="520" style="
                  width:100%;
                  height: calc(100% - (28px * var(--scale)));
                  display:block;
                  border: var(--winBorder) solid #000;
                  image-rendering: pixelated;
                  touch-action:none;
                "></canvas>

                <div class="muted" id="orbitReadout" style="margin-top: calc(6px * var(--scale));">
                  Subsolar: -- · Station: --
                </div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-orbitmap" title="Resize"></div>
          </div>

<div class="window dialog" id="win-about" style="left:260px; top:120px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-about">×</div>
              <div class="wintitle">About the Macintosh</div>
            </div>
            <div class="content">
              <div class="muted">System 1 style mock · Touch + PC ready</div>
              <div class="btnrow">
                <button class="btn" data-close="win-about">OK</button>
              </div>
            </div>
          </div>

          <div class="window dialog" id="win-trash" style="left:360px; top:160px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-trash">×</div>
              <div class="wintitle">Trash</div>
            </div>
            <div class="content">
              <div class="muted">Trash is empty.</div>
              <div class="btnrow">
                <button class="btn" data-close="win-trash">Close</button>
              </div>
            </div>
          </div>

          <div class="window dialog" id="win-alert" style="left:280px; top:200px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-alert">×</div>
              <div class="wintitle" id="alertTitle">Alert</div>
            </div>
            <div class="content">
              <div id="alertMsg">Message</div>
              <div class="btnrow">
                <button class="btn" data-close="win-alert">OK</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="outerTip">
    手机：双指缩放/拖动视图 · PC：拖图标/窗口 · 手动回正：<code>Special → Re-center View</code>
  </div>

<script>
  // ===== Helpers =====
  const root = document.documentElement;
  const center = document.getElementById("center");
  const stageWrap = document.getElementById("stageWrap");
  const stage = document.getElementById("stage");
  const ui = document.getElementById("ui");
  const desktop = document.getElementById("desktop");
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => [...r.querySelectorAll(s)];

  function stageW(){ return parseFloat(getComputedStyle(root).getPropertyValue("--stageW")) || 900; }
  function stageH(){ return parseFloat(getComputedStyle(root).getPropertyValue("--stageH")) || 640; }

  // ===== View state (for mobile pinch/pan) =====
  const view = {
    baseFit: 1,
    userZoom: 1,
    panX: 0,
    panY: 0,
    minZoom: 0.6,
    maxZoom: 3.0,
  };

  function effFit(){ return view.baseFit * view.userZoom; }

  function computeBaseFit(){
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const pad = 16;
    const s = Math.min((vw - pad) / stageW(), (vh - pad) / stageH(), 1);
    view.baseFit = Math.max(0.1, s);
  }

  // ✅ 初始：自动居中 + 自动缩放（由 grid 居中；fit 自适应）
  function resetViewToInitial(){
    computeBaseFit();
    view.userZoom = 1;
    view.panX = 0;
    view.panY = 0;
    applyView();
  }

  function applyView(){
    const fit = effFit();
    root.style.setProperty("--fit", String(fit));

    // clamp pan (prevent losing the stage forever)
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const sw = stageW() * fit;
    const sh = stageH() * fit;

    const margin = 120; // allow some overscroll
    const maxPanX = Math.max(0, (sw + vw)/2 - margin);
    const maxPanY = Math.max(0, (sh + vh)/2 - margin);

    view.panX = Math.max(-maxPanX, Math.min(maxPanX, view.panX));
    view.panY = Math.max(-maxPanY, Math.min(maxPanY, view.panY));

    stageWrap.style.transform = `translate(${view.panX}px, ${view.panY}px)`;
  }

  // resize/orientation: update baseFit but KEEP user zoom & pan (no forced recenter)
  window.addEventListener("resize", () => { computeBaseFit(); applyView(); });
  window.addEventListener("orientationchange", () => { computeBaseFit(); applyView(); });

  // ===== Gesture handling (only on non-interactive background) =====
  const pointers = new Map(); // id -> {x,y, interactive}
  let gesture = null;         // {mode, prevMidX, prevMidY, prevDist, prevEff, startZoom}

  function isInteractiveTarget(t){
    if(!t) return false;
    return !!(t.closest(".icon") || t.closest(".window") || t.closest(".menubar") || t.closest(".dropdown") || t.closest("input, textarea, button, .pane"));
  }
  function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
  function mid(a,b){ return { x:(a.x+b.x)/2, y:(a.y+b.y)/2 }; }

  // ⚠️ 关键修复：仅当“开始点在非交互区域”时，我们才 capture + preventDefault
  function shouldHandleViewportGesture(){
    if(pointers.size === 0) return false;
    for(const p of pointers.values()){
      if(p.interactive) return false;
    }
    return true;
  }

  center.addEventListener("pointerdown", (e) => {
    const interactive = isInteractiveTarget(e.target);
    pointers.set(e.pointerId, { x:e.clientX, y:e.clientY, interactive });

    // 如果起点在交互控件上，不做任何 viewport 捕获/阻止；让图标/窗口正常点击拖动（PC 也靠这个）
    if(interactive) return;

    // only background pointers captured for gesture smoothness
    center.setPointerCapture?.(e.pointerId);

    if(pointers.size === 1){
      const p = pointers.get(e.pointerId);
      gesture = { mode:"pan", prevMidX:p.x, prevMidY:p.y, prevEff: effFit() };
      // 注意：这里不 preventDefault，让单指在空白处仍可点菜单等（菜单本身是 interactive 不会走到这）
    }

    if(pointers.size === 2 && shouldHandleViewportGesture()){
      const [a,b] = [...pointers.values()];
      const m = mid(a,b);
      gesture = {
        mode:"pinch",
        prevMidX: m.x,
        prevMidY: m.y,
        prevDist: Math.max(1, dist(a,b)),
        prevEff: effFit(),
      };
      e.preventDefault();
    }
  }, { passive:false });

  center.addEventListener("pointermove", (e) => {
    const p = pointers.get(e.pointerId);
    if(!p) return;
    p.x = e.clientX; p.y = e.clientY;

    if(!gesture) return;
    if(!shouldHandleViewportGesture()) return;

    if(gesture.mode === "pinch" && pointers.size >= 2){
      const [a,b] = [...pointers.values()];
      const m = mid(a,b);
      const d = Math.max(1, dist(a,b));

      // midpoint pan
      view.panX += (m.x - gesture.prevMidX);
      view.panY += (m.y - gesture.prevMidY);

      // zoom ratio
      const ratio = d / gesture.prevDist;
      const oldZoom = view.userZoom;
      view.userZoom = Math.max(view.minZoom, Math.min(view.maxZoom, view.userZoom * ratio));

      // scale-around-midpoint (keeps content under fingers)
      const oldEff = gesture.prevEff;
      const newEff = effFit();
      const r = newEff / Math.max(0.0001, oldEff);

      const cx = window.innerWidth / 2;
      const cy = window.innerHeight / 2;
      view.panX = r * view.panX + (1 - r) * (m.x - cx);
      view.panY = r * view.panY + (1 - r) * (m.y - cy);

      applyView();

      gesture.prevMidX = m.x;
      gesture.prevMidY = m.y;
      gesture.prevDist = d;
      gesture.prevEff = newEff;

      e.preventDefault();
      return;
    }

    if(gesture.mode === "pan" && pointers.size === 1){
      const only = [...pointers.values()][0];
      view.panX += (only.x - gesture.prevMidX);
      view.panY += (only.y - gesture.prevMidY);
      applyView();
      gesture.prevMidX = only.x;
      gesture.prevMidY = only.y;
      // 不阻止默认也 OK；但某些浏览器可能尝试滚动页面，我们这里 touch-action:none 已禁
      e.preventDefault();
      return;
    }
  }, { passive:false });

  function endPointer(id){
    pointers.delete(id);
    if(pointers.size === 0) gesture = null;
    if(pointers.size === 1){
      const only = [...pointers.values()][0];
      // if remaining pointer is background, keep pan mode
      if(only && !only.interactive){
        gesture = { mode:"pan", prevMidX:only.x, prevMidY:only.y, prevEff: effFit() };
      }else{
        gesture = null;
      }
    }
    if(pointers.size >= 2){
      // re-init pinch baseline
      if(shouldHandleViewportGesture()){
        const [a,b] = [...pointers.values()];
        const m = mid(a,b);
        gesture = { mode:"pinch", prevMidX:m.x, prevMidY:m.y, prevDist:Math.max(1,dist(a,b)), prevEff:effFit() };
      }else{
        gesture = null;
      }
    }
  }
  center.addEventListener("pointerup", (e) => endPointer(e.pointerId), { passive:true });
  center.addEventListener("pointercancel", (e) => endPointer(e.pointerId), { passive:true });

  // ===== Original desktop/window interactions (PC + mobile one-finger) =====
  let zTop = 50;
  let frontWin = null;
  let activeMenu = null;

  function getFit(){ return effFit(); }
  function getScale(){ return parseFloat(getComputedStyle(ui).getPropertyValue("--scale")) || 1; }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function snap(n, step){ return Math.round(n / step) * step; }
  function stageRect(){ return stage.getBoundingClientRect(); }
  function uiRect(){ return ui.getBoundingClientRect(); }
  function desktopRect(){ return desktop.getBoundingClientRect(); }

  // Clock
  function pad2(n){ return String(n).padStart(2,"0"); }
  setInterval(() => {
    const d = new Date();
    $("#clock").textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }, 500);

  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square"; o.frequency.value = 740;
      g.gain.value = 0.03;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(() => { o.stop(); ctx.close(); }, 90);
    }catch(e){}
  }

  function setFront(win){
    if(!win) return;
    $$(".window", ui).forEach(w => w.classList.add("inactive"));
    win.classList.remove("inactive");
    zTop += 1;
    win.style.zIndex = zTop;
    frontWin = win;
  }
  function showWin(id){
    const win = document.getElementById(id);
    if(!win) return;
    win.classList.add("visible");
    setFront(win);

    // If a window was hidden, canvases may have measured as 0x0; re-measure when shown.
    if(id === "win-orbitmap"){
      setTimeout(()=>{
        try{
          if(window.__orbitMapResize) window.__orbitMapResize();
          else if(typeof drawOrbitMap === "function") drawOrbitMap();
        }catch(e){}
      }, 120);
    }
  }
  function hideWin(id){
    const win = document.getElementById(id);
    if(!win) return;
    win.classList.remove("visible");
    if(frontWin === win) frontWin = null;
    const vis = $$(".window.visible", ui);
    if(vis.length) setFront(vis[vis.length-1]);
  }

  // Close buttons
  $$(".closebox", ui).forEach(btn => {
    btn.addEventListener("click", (e) => {
      const id = btn.getAttribute("data-close");
      if(id) hideWin(id);
      e.stopPropagation();
    });
  });


// ✅ Dialog buttons like "OK/Close" use data-close too (not only the titlebar closebox).
// Use delegated handlers to make sure it works on mobile (some browsers don't fire click reliably after pointer capture).
function handleDataClose(e){
  const el = e.target.closest("[data-close]");
  if(!el) return;
  const id = el.getAttribute("data-close");
  if(id) hideWin(id);
  e.preventDefault?.();
  e.stopPropagation?.();
}
ui.addEventListener("click", handleDataClose, true);
ui.addEventListener("pointerup", handleDataClose, true);

  // bring window to front
  $$(".window", ui).forEach(win => win.addEventListener("pointerdown", () => setFront(win)));

  function clearIconSelection(){ $$(".icon", ui).forEach(i => i.classList.remove("selected")); }

  // ===== Desktop initial icon positions (for "Clean Up Desktop" restore) =====
  function captureInitialDesktopPositions(){
    $$(".icon", ui).forEach(icon=>{
      icon.dataset.initLeft = icon.style.left || (icon.getAttribute("style")||"").match(/left:\s*([^;]+)/)?.[1]?.trim() || "";
      icon.dataset.initTop  = icon.style.top  || (icon.getAttribute("style")||"").match(/top:\s*([^;]+)/)?.[1]?.trim()  || "";
    });
  }
  function restoreInitialDesktopPositions(){
    $$(".icon", ui).forEach(icon=>{
      if(icon.dataset.initLeft) icon.style.left = icon.dataset.initLeft;
      if(icon.dataset.initTop)  icon.style.top  = icon.dataset.initTop;
    });
  }


  // Touch open helpers
  function addTapOpen(el, onOpen){
    let lastT = 0;
    el.addEventListener("pointerup", (e) => {
      if(e.pointerType !== "touch") return;
      const now = performance.now();
      if(now - lastT < 320){ onOpen(); lastT = 0; }
      else lastT = now;
    });
  }
  function addLongPressOpen(el, onOpen){
    let timer = null;
    el.addEventListener("pointerdown", (e) => {
      if(e.pointerType !== "touch") return;
      timer = setTimeout(() => { onOpen(); }, 450);
    });
    el.addEventListener("pointermove", () => { if(timer) clearTimeout(timer); timer=null; });
    el.addEventListener("pointerup",   () => { if(timer) clearTimeout(timer); timer=null; });
    el.addEventListener("pointercancel",() => { if(timer) clearTimeout(timer); timer=null; });
  }

  // Drag states
  let dragWin = null, resizeWin = null, dragIcon = null;
  const DRAG_START_PX = 6;

  // ===== Global 2-finger viewport gesture (works even inside windows/canvas) =====
  // Fix: mobile pinch-zoom + two-finger pan should work no matter where fingers start.
  const vp2 = { pointers:new Map(), active:false, prevMidX:0, prevMidY:0, prevDist:0, prevEff:1 };
  let suppressClickUntil = 0;

  function vp2Dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
  function vp2Mid(a,b){ return { x:(a.x+b.x)/2, y:(a.y+b.y)/2 }; }

  function vp2StartIfReady(){
    if(vp2.active) return;
    if(vp2.pointers.size < 2) return;
    const [a,b] = [...vp2.pointers.values()].slice(0,2);
    const m = vp2Mid(a,b);
    vp2.active = true;
    vp2.prevMidX = m.x;
    vp2.prevMidY = m.y;
    vp2.prevDist = Math.max(1, vp2Dist(a,b));
    vp2.prevEff = effFit();

    // cancel any existing background-gesture state (so it won't get stuck if we stop propagation)
    pointers.clear();
    gesture = null;

    // cancel any single-finger drags that may have started before the 2nd finger landed
    dragWin = null; resizeWin = null; dragIcon = null;

    // prevent accidental taps/clicks fired at the end of a pinch
    suppressClickUntil = performance.now() + 480;
  }

  function vp2Update(){
    if(!vp2.active) return;
    if(vp2.pointers.size < 2) return;

    const [a,b] = [...vp2.pointers.values()].slice(0,2);
    const m = vp2Mid(a,b);
    const d = Math.max(1, vp2Dist(a,b));

    // midpoint pan
    view.panX += (m.x - vp2.prevMidX);
    view.panY += (m.y - vp2.prevMidY);

    // zoom ratio
    const ratio = d / vp2.prevDist;
    view.userZoom = Math.max(view.minZoom, Math.min(view.maxZoom, view.userZoom * ratio));

    // scale-around-midpoint (keep content under fingers)
    const oldEff = vp2.prevEff;
    const newEff = effFit();
    const r = newEff / Math.max(0.0001, oldEff);

    const cx = window.innerWidth / 2;
    const cy = window.innerHeight / 2;
    view.panX = r * view.panX + (1 - r) * (m.x - cx);
    view.panY = r * view.panY + (1 - r) * (m.y - cy);

    applyView();

    vp2.prevMidX = m.x;
    vp2.prevMidY = m.y;
    vp2.prevDist = d;
    vp2.prevEff = newEff;
  }

  function vp2End(id){
    vp2.pointers.delete(id);
    if(vp2.active && vp2.pointers.size < 2){
      vp2.active = false;
      // also reset background gesture state
      pointers.clear();
      gesture = null;
      suppressClickUntil = performance.now() + 360;
    }
  }

  // Capture-phase handlers so 2-finger gestures still work even if UI stops propagation
  window.addEventListener("pointerdown", (e) => {
    if(e.pointerType !== "touch") return;
    vp2.pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });
    vp2StartIfReady();

    if(vp2.active){
      // optional: keep receiving moves even if a window/icon captured pointers
      try{ center.setPointerCapture?.(e.pointerId); }catch(_){}
      e.preventDefault();
      e.stopPropagation();
    }
  }, { capture:true, passive:false });

  window.addEventListener("pointermove", (e) => {
    if(e.pointerType !== "touch") return;
    const p = vp2.pointers.get(e.pointerId);
    if(!p) return;
    p.x = e.clientX; p.y = e.clientY;

    if(vp2.active){
      vp2Update();
      e.preventDefault();
      e.stopPropagation();
    }
  }, { capture:true, passive:false });

  window.addEventListener("pointerup", (e) => {
    if(e.pointerType !== "touch") return;
    vp2End(e.pointerId);

    if(vp2.active || performance.now() < suppressClickUntil){
      e.preventDefault();
      e.stopPropagation();
    }
  }, { capture:true, passive:false });

  window.addEventListener("pointercancel", (e) => {
    if(e.pointerType !== "touch") return;
    vp2End(e.pointerId);

    if(vp2.active || performance.now() < suppressClickUntil){
      e.preventDefault();
      e.stopPropagation();
    }
  }, { capture:true, passive:false });

  // Block stray clicks caused by pinch end
  ui.addEventListener("click", (e) => {
    if(performance.now() < suppressClickUntil){
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);


  function onPointerDownTitle(e){
    const win = e.currentTarget.closest(".window");
    if(e.target.closest(".closebox")) return;
    setFront(win);

    const fit = getFit();
    const ur = uiRect();
    const rect = win.getBoundingClientRect();

    dragWin = {
      win,
      pointerId: e.pointerId,
      startX: e.clientX,
      startY: e.clientY,
      origL: (rect.left - ur.left) / fit,
      origT: (rect.top  - ur.top ) / fit,
      fit,
      moved:false
    };

    win.setPointerCapture?.(e.pointerId);
    e.preventDefault();
    e.stopPropagation();
  }
  $$(".window .titlebar", ui).forEach(tb => tb.addEventListener("pointerdown", onPointerDownTitle));

  function onPointerDownResize(e){
    const id = e.currentTarget.getAttribute("data-resize");
    const win = document.getElementById(id);
    if(!win) return;
    setFront(win);

    const fit = getFit();
    const ur = uiRect();
    const rect = win.getBoundingClientRect();

    resizeWin = {
      win,
      pointerId: e.pointerId,
      startX: e.clientX,
      startY: e.clientY,
      origW: rect.width / fit,
      origH: rect.height / fit,
      left: (rect.left - ur.left) / fit,
      top:  (rect.top  - ur.top ) / fit,
      fit
    };

    win.setPointerCapture?.(e.pointerId);
    e.preventDefault();
    e.stopPropagation();
  }
  $$(".resize-handle", ui).forEach(h => h.addEventListener("pointerdown", onPointerDownResize));

  function onPointerDownIcon(e){
    const icon = e.currentTarget;
    clearIconSelection();
    icon.classList.add("selected");

    const fit = getFit();
    const dr = desktopRect();
    const rect = icon.getBoundingClientRect();

    dragIcon = {
      icon,
      pointerId: e.pointerId,
      startX: e.clientX,
      startY: e.clientY,
      origL: (rect.left - dr.left) / fit,
      origT: (rect.top  - dr.top ) / fit,
      fit,
      moved:false
    };

    icon.setPointerCapture?.(e.pointerId);
    e.preventDefault();
    e.stopPropagation();
  }

  $$(".icon", ui).forEach(icon => {
    icon.addEventListener("pointerdown", onPointerDownIcon);
    icon.addEventListener("dblclick", () => {
      const open = icon.getAttribute("data-open");
      if(open) openThing(open);
    });
    addTapOpen(icon, () => { const open = icon.getAttribute("data-open"); if(open) openThing(open); });
    addLongPressOpen(icon, () => { const open = icon.getAttribute("data-open"); if(open) openThing(open); });
  });

  desktop.addEventListener("pointerdown", (e) => {
    if(!e.target.closest(".icon") && !e.target.closest(".window")){
      clearIconSelection();
      closeMenus();
    }
  });

  window.addEventListener("pointermove", (e) => {
    if(resizeWin && e.pointerId === resizeWin.pointerId){
      const fit = resizeWin.fit;
      const dx = (e.clientX - resizeWin.startX) / fit;
      const dy = (e.clientY - resizeWin.startY) / fit;

      const ur = uiRect();
      const uw = ur.width / fit;
      const uh = ur.height / fit;

      const w = resizeWin.win;
      const minW = parseFloat(getComputedStyle(w).minWidth) || 240;
      const minH = parseFloat(getComputedStyle(w).minHeight) || 130;

      const scale = getScale();
      const step = Math.max(6, Math.round(8 * scale));

      const maxW = uw - resizeWin.left - 4;
      const maxH = uh - resizeWin.top - 4;

      let nw = clamp(resizeWin.origW + dx, minW, maxW);
      let nh = clamp(resizeWin.origH + dy, minH, maxH);

      nw = snap(nw, step);
      nh = snap(nh, step);

      w.style.width = nw + "px";
      w.style.height = nh + "px";
      return;
    }

    if(dragWin && e.pointerId === dragWin.pointerId){
      if(!dragWin.moved){
        const dist = Math.hypot(e.clientX - dragWin.startX, e.clientY - dragWin.startY);
        if(dist < DRAG_START_PX) return;
        dragWin.moved = true;
      }

      const fit = dragWin.fit;
      const dx = (e.clientX - dragWin.startX) / fit;
      const dy = (e.clientY - dragWin.startY) / fit;

      const w = dragWin.win;

      const ur = uiRect();
      const uw = ur.width / fit;
      const uh = ur.height / fit;

      const bw = w.offsetWidth;
      const bh = w.offsetHeight;

      const scale = getScale();
      const step = Math.max(6, Math.round(8 * scale));

      let left = snap(dragWin.origL + dx, step);
      let top  = snap(dragWin.origT + dy, step);

      left = clamp(left, 4, uw - bw - 4);
      top  = clamp(top, 4, uh - bh - 4);

      w.style.left = left + "px";
      w.style.top  = top  + "px";
      return;
    }

    if(dragIcon && e.pointerId === dragIcon.pointerId){
      if(!dragIcon.moved){
        const dist = Math.hypot(e.clientX - dragIcon.startX, e.clientY - dragIcon.startY);
        if(dist < DRAG_START_PX) return;
        dragIcon.moved = true;
      }

      const fit = dragIcon.fit;
      const dx = (e.clientX - dragIcon.startX) / fit;
      const dy = (e.clientY - dragIcon.startY) / fit;

      const icon = dragIcon.icon;

      const dr = desktopRect();
      const dw = dr.width / fit;
      const dh = dr.height / fit;

      const scale = getScale();
      const step = Math.max(8, Math.round(10 * scale));

      const bw = icon.offsetWidth;
      const bh = icon.offsetHeight;

      let left = snap(dragIcon.origL + dx, step);
      let top  = snap(dragIcon.origT + dy, step);

      left = clamp(left, 6, dw - bw - 6);
      top  = clamp(top, 6, dh - bh - 6);

      icon.style.left = left + "px";
      icon.style.top  = top  + "px";
    }
  }, { passive:false });

  window.addEventListener("pointerup", (e) => {
    if(resizeWin && e.pointerId === resizeWin.pointerId) resizeWin = null;
    if(dragWin   && e.pointerId === dragWin.pointerId)   dragWin = null;
    if(dragIcon  && e.pointerId === dragIcon.pointerId)  dragIcon = null;
  });

  window.addEventListener("pointercancel", (e) => {
    if(resizeWin && e.pointerId === resizeWin.pointerId) resizeWin = null;
    if(dragWin   && e.pointerId === dragWin.pointerId)   dragWin = null;
    if(dragIcon  && e.pointerId === dragIcon.pointerId)  dragIcon = null;
  });

  // Finder list
  $("#finderList").addEventListener("click", (e) => {
    const item = e.target.closest(".item");
    if(!item) return;
    const open = item.getAttribute("data-open");
    if(open) openThing(open);
  });

  function openThing(key){
    switch(key){
      case "finder": showWin("win-finder"); break;
      case "note": showWin("win-note"); setTimeout(()=>$("#noteArea")?.focus(), 50); break;
      case "calc": showWin("win-calc"); break;
      case "music": showWin("win-music"); break;
      case "about": showWin("win-about"); break;
      case "endivia": showWin("win-endivia"); break;
            case "orbitmap": showWin("win-orbitmap"); break;
      case "trash": showWin("win-trash"); break;
      default: beep();
    }
  }

  // Menus
  const menus = {
    apple: $("#dd-apple"),
    file: $("#dd-file"),
    edit: $("#dd-edit"),
    view: $("#dd-view"),
    special: $("#dd-special")
  };

  function closeMenus(){
    $$(".menu-item", ui).forEach(m => m.classList.remove("active"));
    Object.values(menus).forEach(dd => dd.style.display = "none");
    activeMenu = null;
    $("#appleBtn").style.background = "";
    $("#appleBtn").style.color = "";
  }

  function openMenu(name, anchorEl){
    closeMenus();
    activeMenu = name;

    if(anchorEl.classList.contains("menu-item")) anchorEl.classList.add("active");
    if(name === "apple"){
      $("#appleBtn").style.background = "#000";
      $("#appleBtn").style.color = "#fff";
    }

    const dd = menus[name];
    if(!dd) return;

    const sr = stageRect();
    const r = anchorEl.getBoundingClientRect();
    const fit = getFit();

    dd.style.left = Math.max(6, (r.left - sr.left) / fit) + "px";
    dd.style.display = "block";
  }

  $("#appleBtn").addEventListener("click", (e) => {
    if(activeMenu === "apple"){ closeMenus(); return; }
    openMenu("apple", e.currentTarget);
    e.stopPropagation();
  });

  $$(".menu-item", ui).forEach(mi => {
    mi.addEventListener("click", (e) => {
      const name = mi.getAttribute("data-menu");
      if(activeMenu === name){ closeMenus(); return; }
      openMenu(name, mi);
      e.stopPropagation();
    });
  });

  ui.addEventListener("pointerdown", (e) => {
    if(e.target.closest(".dropdown") || e.target.closest(".menubar")) return;
    closeMenus();
  });

  // Dropdown actions
  function alertBox(title, msg){
    $("#alertTitle").textContent = title;
    $("#alertMsg").textContent = msg;
    showWin("win-alert");
  }

  function cleanUpDesktop(){
    // Restore the original icon layout (System 1 style) instead of reflowing.
    restoreInitialDesktopPositions();
    clearIconSelection();
    beep();
  }

  function applyAction(act){
    switch(act){
      case "about": showWin("win-about"); break;
      case "openFinder": showWin("win-finder"); break;
      case "openNote": showWin("win-note"); setTimeout(()=>$("#noteArea")?.focus(), 50); break;
      case "openCalc": showWin("win-calc"); break;
      case "openMusic": showWin("win-music"); break;
      case "openOrbitMap": showWin("win-orbitmap"); break;
      case "cleanup": cleanUpDesktop(); break;

      case "recenter": resetViewToInitial(); break;

      case "scaleNormal": document.body.classList.remove("big","huge"); break;
      case "scaleBig": document.body.classList.remove("huge"); document.body.classList.add("big"); break;
      case "scaleHuge": document.body.classList.remove("big"); document.body.classList.add("huge"); break;

      case "closeFront": if(frontWin) hideWin(frontWin.id); else beep(); break;
      default: beep();
    }
  }

  $$(".dropdown", ui).forEach(dd => {
    dd.addEventListener("click", (e) => {
      const row = e.target.closest(".row");
      if(!row) return;
      const act = row.getAttribute("data-action");
      if(act && act !== "sep"){
        applyAction(act);
        closeMenus();
      }
    });
  });

  // Calculator
  const calcDisplay = $("#calcDisplay");
  let calcState = { display: "0", first: null, op: null, waiting: false };
  function calcRender(){
    const s = calcState.display;
    calcDisplay.textContent = (s.length > 14) ? s.slice(0, 14) : s;
  }
  function calcClear(){ calcState = { display:"0", first:null, op:null, waiting:false }; calcRender(); }
  function calcBackspace(){
    if(calcState.waiting) return;
    const s = calcState.display;
    calcState.display = (s.length <= 1) ? "0" : s.slice(0,-1);
    calcRender();
  }
  function calcInputDigit(d){
    if(calcState.waiting){ calcState.display = d; calcState.waiting = false; }
    else calcState.display = (calcState.display === "0") ? d : (calcState.display + d);
    calcRender();
  }
  function calcInputDot(){
    if(calcState.waiting){ calcState.display = "0."; calcState.waiting = false; calcRender(); return; }
    if(!calcState.display.includes(".")){ calcState.display += "."; calcRender(); }
  }
  function calcCompute(a,b,op){
    if(op === "+") return a + b;
    if(op === "-") return a - b;
    if(op === "*") return a * b;
    if(op === "/") return (b === 0) ? NaN : (a / b);
    return b;
  }
  function calcOperator(nextOp){
    const input = parseFloat(calcState.display);
    if(calcState.first == null) calcState.first = input;
    else if(calcState.op && !calcState.waiting){
      const result = calcCompute(calcState.first, input, calcState.op);
      calcState.first = result;
      calcState.display = Number.isFinite(result) ? String(result) : "Error";
    }
    calcState.op = nextOp;
    calcState.waiting = true;
    calcRender();
  }
  function calcEquals(){
    const input = parseFloat(calcState.display);
    if(calcState.op == null || calcState.first == null || calcState.waiting) return;
    const result = calcCompute(calcState.first, input, calcState.op);
    calcState.display = Number.isFinite(result) ? String(result) : "Error";
    calcState.first = null; calcState.op = null; calcState.waiting = true;
    calcRender();
  }
  function calcPercent(){
    const v = parseFloat(calcState.display);
    if(!Number.isFinite(v)) return;
    calcState.display = String(v / 100);
    calcRender();
  }
  function calcPress(k){
    if(k >= "0" && k <= "9") return calcInputDigit(k);
    if(k === ".") return calcInputDot();
    if(k === "C") return calcClear();
    if(k === "BS") return calcBackspace();
    if(k === "%") return calcPercent();
    if(k === "+" || k === "-" || k === "*" || k === "/") return calcOperator(k);
    if(k === "=") return calcEquals();
  }
  $("#win-calc").addEventListener("click", (e) => {
    const btn = e.target.closest(".key");
    if(!btn) return;
    const k = btn.getAttribute("data-k");
    if(k) calcPress(k);
  });
  calcRender();

  // Music
  const music = {
    audio: new Audio("song.mp3"),
    seek: $("#musicSeek"),
    state: $("#musicState"),
    time: $("#musicTime"),
    dur: $("#musicDur"),
    status: $("#musicStatus"),
    seeking: false
  };
  music.audio.preload = "metadata";
  function fmtTime(sec){
    if(!Number.isFinite(sec) || sec < 0) return "0:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${String(s).padStart(2,"0")}`;
  }
  function syncMusicUI(){
    const a = music.audio;
    const d = Number.isFinite(a.duration) ? a.duration : 0;
    if(!music.seeking){
      music.seek.max = String(d || 0);
      music.seek.value = String(a.currentTime || 0);
    }
    $("#musicTime").textContent = fmtTime(a.currentTime || 0);
    $("#musicDur").textContent = fmtTime(d || 0);
    $("#musicState").textContent = a.paused ? "STOP" : "PLAY";
  }
  music.audio.addEventListener("loadedmetadata", () => { music.status.textContent = "Loaded"; syncMusicUI(); });
  music.audio.addEventListener("timeupdate", syncMusicUI);
  music.audio.addEventListener("play", () => { music.status.textContent = "Playing"; syncMusicUI(); });
  music.audio.addEventListener("pause", () => { music.status.textContent = "Paused"; syncMusicUI(); });
  music.audio.addEventListener("error", () => {
    music.status.textContent = "Cannot load song.mp3";
    alertBox("Music Player", "无法加载 song.mp3。请确认它与本 HTML 同目录，并已正确上传。");
  });

  async function musicPlay(){
    try{ await music.audio.play(); }
    catch(err){
      music.status.textContent = "Playback blocked";
      alertBox("Music Player", "浏览器阻止了播放（需要用户手势）。请点击 Play 再试。");
    }
  }
  $("#musicPlay").addEventListener("click", musicPlay);
  $("#musicPause").addEventListener("click", () => music.audio.pause());
  music.seek.addEventListener("input", () => {
    music.seeking = true;
    const t = parseFloat(music.seek.value);
    if(Number.isFinite(t)) music.audio.currentTime = t;
    syncMusicUI();
  });
  music.seek.addEventListener("change", () => {
    music.seeking = false;
    syncMusicUI();
  });


  // ===== Endivia (in-system website) =====
  function showEndiviaTab(name){
    const pages = $$('#endiviaPage [data-endivia-page]');
    pages.forEach(p => p.style.display = (p.getAttribute('data-endivia-page') === name) ? '' : 'none');
  }
  showEndiviaTab('rooms');

  $$('#win-endivia [data-endivia-tab]').forEach(btn => {
    btn.addEventListener('click', () => showEndiviaTab(btn.getAttribute('data-endivia-tab')));
  });

  $$('#win-endivia [data-endivia-book]').forEach(btn => {
    btn.addEventListener('click', () => {
      const room = btn.getAttribute('data-endivia-book');
      alertBox('Endivia Booking', `已选择房型：${room}\n\n(演示站点：未实际提交订单)`);
    });
  });

  // Init
  resetViewToInitial();
  captureInitialDesktopPositions();
  showWin("win-finder");
  setFront($("#win-finder"));
  syncMusicUI();

  // ===== Orbit Map (Day/Night Terminator + Station Ground Track) =====
  const orbit = {
    altitude_km: 412,
    inc_deg: 51.6,
    period_s: 92 * 60,
    earth_rot: 7.2921159e-5, // rad/s
    epoch_ms: Date.now(),
    trail: [],
    trailOn: true
  };

  const orbitCanvas = document.getElementById("orbitCanvas");
  const orbitCtx = orbitCanvas ? orbitCanvas.getContext("2d") : null;
  const orbitReadout = document.getElementById("orbitReadout");
  const orbitMapTime = document.getElementById("orbitMapTime");

  // Build a real pixel-art world map (monochrome) once, then scale it up on the main canvas.
  const worldMap = { w: 240, h: 120, cvs: null, ctx: null, built: false };
  function buildPixelWorldMap(){
    if(worldMap.built) return;
    worldMap.cvs = document.createElement("canvas");
    worldMap.cvs.width = worldMap.w;
    worldMap.cvs.height = worldMap.h;
    worldMap.ctx = worldMap.cvs.getContext("2d");
    const c = worldMap.ctx;

    // ocean
    c.imageSmoothingEnabled = false;
    c.fillStyle = "#fff";
    c.fillRect(0,0,worldMap.w,worldMap.h);

    // continents (drawn in lon/lat space then rasterized -> pixel map look)
    function poly(points){
      c.beginPath();
      points.forEach((p,i)=>{
        const xy = lonLatToXY(p[0], p[1], worldMap.w, worldMap.h);
        if(i===0) c.moveTo(xy.x, xy.y); else c.lineTo(xy.x, xy.y);
      });
      c.closePath();
      c.fill();
    }
    c.fillStyle = "#000";

    // North America (rough but recognizable)
    poly([[-168,12],[-140,15],[-125,30],[-120,45],[-130,58],[-150,70],[-168,62],[-168,12]]);
    poly([[-125,25],[-100,20],[-85,25],[-80,35],[-88,48],[-105,55],[-120,48],[-125,25]]);
    poly([[-55,50],[-20,55],[-20,75],[-55,78],[-70,70],[-55,50]]); // Greenland-ish

    // South America
    poly([[-82,12],[-68,10],[-50,-5],[-44,-25],[-54,-55],[-70,-55],[-80,-30],[-82,12]]);

    // Europe + Asia (Eurasia big mass)
    poly([[-10,35],[15,32],[40,40],[60,55],[90,65],[120,62],[150,55],[170,50],[170,75],[-10,75],[-25,60],[-10,35]]);
    // India / SEA bump
    poly([[70,25],[85,20],[100,10],[112,5],[110,-5],[95,0],[82,10],[70,25]]);
    // Japan / islands
    poly([[130,30],[140,30],[146,38],[140,45],[132,42],[130,30]]);
    // Indonesia
    poly([[105,0],[120,-5],[135,-5],[140,-10],[125,-12],[110,-10],[105,0]]);

    // Africa
    poly([[-18,35],[10,35],[35,25],[45,5],[40,-20],[25,-35],[5,-35],[-10,-25],[-18,0],[-18,35]]);
    // Madagascar
    poly([[46,-13],[52,-15],[52,-25],[47,-26],[46,-13]]);

    // Australia
    poly([[112,-10],[155,-10],[160,-25],[150,-42],[120,-44],[110,-30],[112,-10]]);

    // Antarctica strip
    poly([[-180,-72],[180,-72],[180,-90],[-180,-90]]);

    // Add a tiny bit of coastline "pixel jitter" for a more authentic bitmap feel
    const img = c.getImageData(0,0,worldMap.w,worldMap.h);
    const d = img.data;
    function isLand(ix){
      return d[ix]===0 && d[ix+1]===0 && d[ix+2]===0 && d[ix+3]>0;
    }
    for(let y=1; y<worldMap.h-1; y++){
      for(let x=1; x<worldMap.w-1; x++){
        const i = (y*worldMap.w + x)*4;
        const land = isLand(i);
        if(!land) continue;
        // if any neighbor is ocean, randomly nibble a pixel to make jagged edges
        const n1 = ((y-1)*worldMap.w + x)*4;
        const n2 = ((y+1)*worldMap.w + x)*4;
        const n3 = (y*worldMap.w + (x-1))*4;
        const n4 = (y*worldMap.w + (x+1))*4;
        const edge = !(isLand(n1)&&isLand(n2)&&isLand(n3)&&isLand(n4));
        if(edge){
          // deterministic pseudo-random based on coords
          const r = (x*73856093 ^ y*19349663) & 255;
          if(r < 18){
            d[i]=255; d[i+1]=255; d[i+2]=255; d[i+3]=255;
          }
        }
      }
    }
    c.putImageData(img,0,0);

    worldMap.built = true;
  }

  function drawWorldMap(ctx, W, H){
    buildPixelWorldMap();
    ctx.save();
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(worldMap.cvs, 0, 0, W, H);
    ctx.restore();
  }
  const btnOrbitRecenter = document.getElementById("orbitMapRecenter");
  const btnOrbitTrail = document.getElementById("orbitMapTrail");

  function deg2rad(d){ return d*Math.PI/180; }
  function rad2deg(r){ return r*180/Math.PI; }
  function wrapLon(lon){ return ((lon + 180) % 360 + 360) % 360 - 180; }
  function clampLat(lat){ return Math.max(-89.999, Math.min(89.999, lat)); }

  // Solar position (lightweight, good enough for a moving terminator)
  function solarDeclinationRad(date){
    const start = Date.UTC(date.getUTCFullYear(),0,1);
    const doy = (Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()) - start) / 86400000 + 1;
    const gamma = 2*Math.PI/365 * (doy - 1 + (date.getUTCHours()-12)/24);
    return (0.006918
      - 0.399912*Math.cos(gamma) + 0.070257*Math.sin(gamma)
      - 0.006758*Math.cos(2*gamma) + 0.000907*Math.sin(2*gamma)
      - 0.002697*Math.cos(3*gamma) + 0.00148*Math.sin(3*gamma));
  }
  function subsolarLonDeg(date){
    const utcHours = date.getUTCHours() + date.getUTCMinutes()/60 + date.getUTCSeconds()/3600;
    return wrapLon((12 - utcHours) * 15);
  }
  function sunUnitVector_ECEF(date){
    const dec = solarDeclinationRad(date);
    const lon = deg2rad(subsolarLonDeg(date));
    return {
      x: Math.cos(dec)*Math.cos(lon),
      y: Math.cos(dec)*Math.sin(lon),
      z: Math.sin(dec),
      dec, lon
    };
  }
  function isDay(latDeg, lonDeg, sun){
    const lat = deg2rad(latDeg), lon = deg2rad(lonDeg);
    const nx = Math.cos(lat)*Math.cos(lon);
    const ny = Math.cos(lat)*Math.sin(lon);
    const nz = Math.sin(lat);
    return (nx*sun.x + ny*sun.y + nz*sun.z) > 0;
  }
  function terminatorLatDeg(lonDeg, sun){
    const dlon = deg2rad(wrapLon(lonDeg - rad2deg(sun.lon)));
    const sinD = Math.sin(sun.dec);
    const cosD = Math.cos(sun.dec);
    const c = Math.cos(dlon);
    if(Math.abs(sinD) < 1e-6) return 0;
    return rad2deg(Math.atan2(-cosD * c, sinD));
  }

  // Orbit model (simple, demo-grade)
  function stationSubpoint(date){
    const t = (date.getTime() - orbit.epoch_ms)/1000;
    const inc = deg2rad(orbit.inc_deg);
    const n = 2*Math.PI / orbit.period_s;
    const nu = n * t;

    const xo = Math.cos(nu);
    const yo = Math.sin(nu);

    // ECI (RAAN=0)
    const x_eci = xo;
    const y_eci = yo*Math.cos(inc);
    const z_eci = yo*Math.sin(inc);

    // ECEF rotate -theta
    const theta = orbit.earth_rot * t;
    const c = Math.cos(-theta), s = Math.sin(-theta);
    const x = c*x_eci - s*y_eci;
    const y = s*x_eci + c*y_eci;
    const z = z_eci;

    const lat = rad2deg(Math.asin(z / Math.hypot(x,y,z)));
    const lon = wrapLon(rad2deg(Math.atan2(y,x)));
    return {lat, lon};
  }

  function lonLatToXY(lon, lat, W, H){
    const x = (wrapLon(lon) + 180) / 360 * W;
    const y = (90 - clampLat(lat)) / 180 * H;
    return {x,y};
  }

  // Wrapped polyline stroker for lon/lat sequences (handles dateline jumps)
  function strokeLonLatWrapped(ctx, pts, W, H, opts={}){
    const offsetX = opts.offsetX || 0;
    const offsetY = opts.offsetY || 0;
    let started = false;
    let prev = null;
    for(const p of pts){
      const lon = wrapLon(p.lon);
      const lat = clampLat(p.lat);
      const xy = lonLatToXY(lon, lat, W, H);
      const x = xy.x + offsetX, y = xy.y + offsetY;

      if(prev){
        const dLon = Math.abs(lon - prev.lon);
        const dX = Math.abs(x - prev.x);
        // Split on dateline wrap (either lon jump or big pixel jump)
        if(dLon > 180 || dX > W/2){
          started = false;
        }
      }
      if(!started){
        ctx.moveTo(x, y);
        started = true;
      }else{
        ctx.lineTo(x, y);
      }
      prev = { lon, x, y };
    }
  }

  // True terminator curve as a great-circle (plane orthogonal to Sun vector)
  function terminatorPoints(sun, samples=720){
    const sx = sun.x, sy = sun.y, sz = sun.z;

    // pick an "up" that isn't parallel to sun
    let ax=0, ay=0, az=1;
    if(Math.abs(sz) > 0.9){ ax=0; ay=1; az=0; }

    // u = normalize(cross(s, a))
    let ux = sy*az - sz*ay;
    let uy = sz*ax - sx*az;
    let uz = sx*ay - sy*ax;
    let ul = Math.hypot(ux,uy,uz) || 1;
    ux/=ul; uy/=ul; uz/=ul;

    // v = cross(s, u)
    let vx = sy*uz - sz*uy;
    let vy = sz*ux - sx*uz;
    let vz = sx*uy - sy*ux;

    const pts = [];
    for(let i=0;i<=samples;i++){
      const a = (i/samples) * Math.PI*2;
      const ca = Math.cos(a), sa = Math.sin(a);
      const x = ca*ux + sa*vx;
      const y = ca*uy + sa*vy;
      const z = ca*uz + sa*vz;

      const lat = rad2deg(Math.asin(z));
      const lon = wrapLon(rad2deg(Math.atan2(y,x)));
      pts.push({lon, lat});
    }
    return pts;
  }

  function drawTerminatorCurve(ctx, W, H, sun){
    const pts = terminatorPoints(sun, 720);

    // dark edge
    ctx.save();
    ctx.strokeStyle = "rgba(0,0,0,.92)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    strokeLonLatWrapped(ctx, pts, W, H);
    ctx.stroke();

    // subtle glow
    ctx.strokeStyle = "rgba(255,255,255,.55)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    strokeLonLatWrapped(ctx, pts, W, H, {offsetY:0.5});
    ctx.stroke();
    ctx.restore();
  }

  function drawGraticule(ctx, W, H){
    ctx.save();
    ctx.strokeStyle = "rgba(0,0,0,.18)";
    ctx.lineWidth = 1;
    ctx.setLineDash([2,3]);
    for(let lon=-180; lon<=180; lon+=30){
      const x = (lon+180)/360*W;
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    }
    for(let lat=-60; lat<=60; lat+=30){
      const y = (90-lat)/180*H;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
    }
    ctx.setLineDash([]);
    // border
    ctx.strokeStyle = "rgba(0,0,0,.35)";
    ctx.lineWidth = 2;
    ctx.strokeRect(0.5,0.5,W-1,H-1);
    ctx.restore();
  }

  function drawLand(ctx, W, H){
    ctx.save();
    ctx.fillStyle = "#fff";
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;

    const blobs = [
      [[-165, 15],[-55,15],[-55,72],[-165,72]],       // N. America
      [[-85,-55],[-30,-55],[-30,12],[-85,12]],        // S. America
      [[-10, 10],[170,10],[170,75],[-10,75]],         // Eurasia
      [[-20,-35],[50,-35],[50,35],[-20,35]],          // Africa
      [[110,-45],[155,-45],[155,-10],[110,-10]],      // Australia
      [[-60, 60],[-20,60],[-20,80],[-60,80]],         // Greenland
      [[-180,-90],[180,-90],[180,-72],[-180,-72]]     // Antarctica strip
    ];

    for(const poly of blobs){
      ctx.beginPath();
      poly.forEach((p,i)=>{
        const xy = lonLatToXY(p[0], p[1], W, H);
        if(i===0) ctx.moveTo(xy.x, xy.y); else ctx.lineTo(xy.x, xy.y);
      });
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
    }

    ctx.restore();
  }


  function drawNightMask(ctx, W, H, sun){
    // Pixel-ish night overlay by sampling a coarse grid and classifying day/night via dot product.
    ctx.save();
    ctx.imageSmoothingEnabled = false;

    const step = Math.max(2, Math.floor(Math.min(W, H) / 180)); // bigger => chunkier pixels
    ctx.fillStyle = "rgba(0,0,0,.52)";

    for(let y=0; y<H; y+=step){
      const lat = 90 - ((y + step*0.5) / H) * 180;
      for(let x=0; x<W; x+=step){
        const lon = (x + step*0.5) / W * 360 - 180;
        if(!isDay(lat, lon, sun)){
          ctx.fillRect(x, y, step, step);
        }
      }
    }

    // Crisp terminator curve on top
    drawTerminatorCurve(ctx, W, H, sun);

    ctx.restore();
  }

  function drawStation(ctx, W, H, station){
    const p = lonLatToXY(station.lon, station.lat, W, H);

    // marker
    ctx.save();
    ctx.fillStyle = "#000";
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();

    // tiny "station" cross
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(p.x-10, p.y); ctx.lineTo(p.x+10, p.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(p.x, p.y-10); ctx.lineTo(p.x, p.y+10); ctx.stroke();

    ctx.restore();
  }

  function drawTrail(ctx, W, H){
    if(!orbit.trailOn || orbit.trail.length < 2) return;
    ctx.save();
    ctx.strokeStyle = "rgba(0,0,0,.6)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    let moved = false;
    for(const pt of orbit.trail){
      const p = lonLatToXY(pt.lon, pt.lat, W, H);
      if(!moved){ ctx.moveTo(p.x, p.y); moved = true; }
      else ctx.lineTo(p.x, p.y);
    }
    ctx.strokeStyle = "rgba(255,255,255,.9)";
    ctx.lineWidth = 5;
    ctx.stroke();
    ctx.strokeStyle = "rgba(0,0,0,.85)";
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();
  }

  function drawGroundTrack(ctx, W, H, now){
    // Draw one full orbit behind and ahead of now (solid past, dashed future)
    const nowMs = now.getTime();
    const periodMs = orbit.period_s * 1000;
    const startMs = nowMs - periodMs;
    const endMs   = nowMs + periodMs;
    const stepMs  = 30 * 1000; // 30s samples

    const past = [];
    const future = [];

    for(let t=startMs; t<=endMs; t+=stepMs){
      const st = stationSubpoint(new Date(t));
      (t <= nowMs ? past : future).push(st);
    }

    function strokeTrack(points, dashed){
      if(points.length < 2) return;
      ctx.save();
      ctx.setLineDash(dashed ? [8,6] : []);
      ctx.beginPath();
      strokeLonLatWrapped(ctx, points, W, H);
      // dual-stroke so the track is visible over both ocean (white) and land (black)
      ctx.strokeStyle = "rgba(255,255,255,.95)";
      ctx.lineWidth = 5;
      ctx.stroke();
      ctx.strokeStyle = "rgba(0,0,0,.9)";
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
    }

    // Past (solid) and future (dashed)
    strokeTrack(past, false);
    strokeTrack(future, true);

    // Small sample dots (classic feel)
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.strokeStyle = "rgba(0,0,0,.85)";
    ctx.lineWidth = 1;
    for(const p of past){
      const xy = lonLatToXY(p.lon, p.lat, W, H);
      ctx.fillRect(xy.x-1, xy.y-1, 2, 2);
      ctx.strokeRect(xy.x-1, xy.y-1, 2, 2);
    }
    ctx.restore();
  }

  function drawOrbitMap(){
    if(!orbitCtx || !orbitCanvas) return;

    const now = new Date();
    const sun = sunUnitVector_ECEF(now);
    const st  = stationSubpoint(now);

    // trail: keep last 2 hours worth
    orbit.trail.push({lat: st.lat, lon: st.lon, t: now.getTime()});
    const cutoff = now.getTime() - 2*60*60*1000;
    orbit.trail = orbit.trail.filter(p => p.t >= cutoff);

    const W = orbitCanvas.width, H = orbitCanvas.height;

    // background
    orbitCtx.clearRect(0,0,W,H);
    orbitCtx.fillStyle = "#fff";
    orbitCtx.fillRect(0,0,W,H);
    drawWorldMap(orbitCtx, W, H);
    drawGraticule(orbitCtx, W, H);
    drawNightMask(orbitCtx, W, H, sun);
    drawGroundTrack(orbitCtx, W, H, now);
    drawTrail(orbitCtx, W, H);
    drawStation(orbitCtx, W, H, st);

    // readout
    const sslat = rad2deg(sun.dec);
    const sslon = wrapLon(rad2deg(sun.lon));
    if(orbitReadout){
      orbitReadout.innerHTML =
        'Subsolar: <b>' + sslat.toFixed(1) + '°</b>, <b>' + sslon.toFixed(1) + '°</b> · ' +
        'Station: <b>' + st.lat.toFixed(1) + '°</b>, <b>' + st.lon.toFixed(1) + '°</b>';
    }
    if(orbitMapTime){
      orbitMapTime.textContent = now.toLocaleString();
    }
  }

  function initOrbitMap(){
    if(!orbitCanvas) return;

    // scale canvas to device pixel ratio for crispness
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    function resizeCanvas(){
      const rect = orbitCanvas.getBoundingClientRect();
      const w = Math.max(320, Math.floor(rect.width * dpr));
      const h = Math.max(200, Math.floor(rect.height * dpr));
      orbitCanvas.width = w;
      orbitCanvas.height = h;
      drawOrbitMap();
    }
    // expose for showWin() so it can redraw after the window becomes visible
    window.__orbitMapResize = resizeCanvas;
    window.addEventListener("resize", resizeCanvas);
    setTimeout(resizeCanvas, 100);

    // buttons
    if(btnOrbitRecenter){
      btnOrbitRecenter.addEventListener("click", ()=>{ orbit.trail = []; drawOrbitMap(); });
    }
    if(btnOrbitTrail){
      btnOrbitTrail.addEventListener("click", ()=>{
        orbit.trailOn = !orbit.trailOn;
        btnOrbitTrail.textContent = "Trail: " + (orbit.trailOn ? "ON" : "OFF");
        drawOrbitMap();
      });
    }

    // refresh
    setInterval(drawOrbitMap, 1000);
  }
  initOrbitMap();

</script>
</body>
</html>
