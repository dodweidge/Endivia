<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Macintosh (System 1) Mock · Pixel + Apps</title>
  <style>
    :root{
      /* 固定“屏幕”逻辑尺寸（中间那块） */
      --stageW: 900; /* px */
      --stageH: 640; /* px */
      --fit: 1;

      /* UI 缩放（可切换 Normal/Big/Huge） */
      --scale: 1.0;
      --ui: 12px;
      --barH: calc(22px * var(--scale));
      --winBorder: 2px;

      /* 1-bit 黑白 */
      --bw:#000;
      --paper:#fff;
      --desk1:#e9e9e9;
      --desk2:#d9d9d9;
      --shadow: rgba(0,0,0,.35);
      --sel:#000;
      --selText:#fff;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      overflow:hidden;

      /* 像素背景：点阵 + 斜纹 + 暗角 + 轻微彩噪 */
      background:
        radial-gradient(1200px 800px at 50% 40%, rgba(255,255,255,.12), transparent 55%),
        radial-gradient(900px 600px at 20% 70%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.18), transparent 20%, transparent 80%, rgba(0,0,0,.35)),
        repeating-linear-gradient(45deg, rgba(255,255,255,.06) 0 6px, rgba(0,0,0,.04) 6px 12px),
        radial-gradient(circle, rgba(0,0,0,.14) 1px, transparent 1px);
      background-size: auto, auto, auto, auto, 6px 6px;

      /* “像素字体感”：关平滑 + 速度渲染（不同浏览器效果不同，但会更硬朗） */
      font-family: "MS Gothic", "SimSun", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: auto;
      text-rendering: optimizeSpeed;

      color: #fff;
    }

    /* 居中舞台 */
    .center{
      position: fixed;
      inset: 0;
      display:grid;
      place-items:center;
      padding: 24px;
    }
    .stageWrap{
      transform: scale(var(--fit));
      transform-origin: center;
      filter:
        drop-shadow(0 26px 0 rgba(0,0,0,.35))
        drop-shadow(0 18px 38px rgba(0,0,0,.35));
    }
    .stage{
      width: calc(var(--stageW) * 1px);
      height: calc(var(--stageH) * 1px);
      position: relative;
      overflow: hidden;

      /* 显示器边框 */
      border: 5px solid #000;
      background: #fff;

      /* 略微“老显示器”对比 */
      filter: contrast(1.06);
    }

    /* CRT/像素扫描感 + 更强 dither 强化 */
    .stage::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        /* 扫描线 */
        repeating-linear-gradient(to bottom, rgba(0,0,0,.07) 0 1px, transparent 1px 3px),
        /* 更强的点阵抖动 */
        radial-gradient(circle, rgba(0,0,0,.12) 1px, transparent 1px),
        /* 暗角 */
        radial-gradient(900px 600px at 50% 45%, rgba(0,0,0,.20), transparent 60%);
      background-size: auto, 4px 4px, auto;
      opacity:.55;
      mix-blend-mode:multiply;
    }

    /* ====== UI Inside Stage ====== */
    .ui{
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(45deg, var(--desk1) 0 2px, var(--desk2) 2px 4px);
      user-select: none;
      color: var(--bw);
    }
    /* 强化 1-bit / dither 的“前景噪点” */
    .ui::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle, rgba(0,0,0,.10) 1px, transparent 1px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.04) 0 1px, transparent 1px 6px);
      background-size: 6px 6px, 7px 7px;
      opacity:.16;
      mix-blend-mode:multiply;
    }

    /* Menu bar */
    .menubar{
      position: absolute;
      left:0; right:0; top:0;
      height: var(--barH);
      background: var(--paper);
      border-bottom: var(--winBorder) solid var(--bw);
      display:flex;
      align-items:center;
      padding: 0 calc(8px * var(--scale));
      gap: calc(10px * var(--scale));
      z-index: 9999;
      font-size: calc(var(--ui) * var(--scale));
      line-height: 1;
    }
    .menu-left,.menu-right{ display:flex; align-items:center; gap: calc(10px * var(--scale)); }
    .menu-right{ margin-left:auto; gap: calc(12px * var(--scale)); }
    .apple{
      width: calc(16px * var(--scale));
      height: calc(16px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      display:grid;
      place-items:center;
      font-weight:700;
      font-size: calc(12px * var(--scale));
      cursor:pointer;
      background: transparent;
    }
    .menu-item{
      padding: calc(3px * var(--scale)) calc(6px * var(--scale));
      cursor:pointer;
      border:1px solid transparent;
    }
    .menu-item.active{ background: var(--bw); color: var(--paper); }

    /* Dropdown */
    .dropdown{
      position: absolute;
      top: calc(var(--barH) - 1px);
      min-width: calc(220px * var(--scale));
      background: var(--paper);
      border: var(--winBorder) solid var(--bw);
      box-shadow: 0 calc(8px * var(--scale)) 0 var(--shadow);
      display:none;
      z-index: 9998;
      font-size: calc(var(--ui) * var(--scale));
    }
    .dropdown .row{
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: calc(6px * var(--scale)) calc(10px * var(--scale));
      border-bottom: 1px solid rgba(0,0,0,.2);
      cursor:pointer;
    }
    .dropdown .row:last-child{ border-bottom:0; }
    .dropdown .row:hover{ background: var(--bw); color: var(--paper); }
    .kbd{ opacity:.75; margin-left: calc(12px * var(--scale)); }
    .muted{ opacity:.7; }

    /* Desktop */
    .desktop{
      position:absolute;
      left:0; right:0;
      top: var(--barH);
      bottom:0;
      padding: calc(14px * var(--scale));
    }

    /* Icons */
    .icon{
      position:absolute;
      width: calc(76px * var(--scale));
      text-align:center;
      cursor: default;
      touch-action: none;
    }
    .icon .glyph{
      width: calc(36px * var(--scale));
      height: calc(36px * var(--scale));
      margin: 0 auto calc(6px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
      display:grid;
      place-items:center;
    }
    .icon .label{
      display:inline-block;
      padding: calc(2px * var(--scale)) calc(4px * var(--scale));
      font-size: calc(var(--ui) * var(--scale));
      line-height:1.15;
      background: transparent;
      color: var(--bw);
    }
    .icon.selected .label{ background: var(--sel); color: var(--selText); }

    /* Windows */
    .window{
      position:absolute;
      background: var(--paper);
      border: var(--winBorder) solid var(--bw);
      box-shadow: 0 calc(10px * var(--scale)) 0 var(--shadow);
      min-width: calc(240px * var(--scale));
      min-height: calc(130px * var(--scale));
      display:none;
      touch-action:none;
    }
    .window.visible{ display:block; }
    .window.inactive{ opacity:.95; }

    .titlebar{
      height: calc(22px * var(--scale));
      border-bottom: var(--winBorder) solid var(--bw);
      display:flex;
      align-items:center;
      gap: calc(8px * var(--scale));
      padding: 0 calc(8px * var(--scale));
      cursor: move;
      background:
        repeating-linear-gradient(90deg, transparent 0 6px, rgba(0,0,0,.14) 6px 7px);
    }
    .closebox{
      width: calc(14px * var(--scale));
      height: calc(14px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
      cursor:pointer;
      flex:0 0 auto;
      display:grid;
      place-items:center;
      font-size: calc(10px * var(--scale));
      line-height:1;
    }
    .wintitle{
      flex:1 1 auto;
      text-align:center;
      font-size: calc(var(--ui) * var(--scale));
      letter-spacing:.02em;
      font-weight:700;
      padding-right: calc(18px * var(--scale));
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .content{
      position:relative;
      padding: calc(10px * var(--scale));
      font-size: calc(var(--ui) * var(--scale));
      line-height:1.35;
    }

    /* Resize handle */
    .resize-handle{
      position:absolute;
      right: 2px;
      bottom: 2px;
      width: calc(16px * var(--scale));
      height: calc(16px * var(--scale));
      border-left: var(--winBorder) solid var(--bw);
      border-top: var(--winBorder) solid var(--bw);
      background:
        repeating-linear-gradient(135deg, transparent 0 3px, rgba(0,0,0,.22) 3px 4px);
      cursor: nwse-resize;
    }
    .window.dialog .resize-handle{ display:none; }

    /* Scrollframe */
    .scrollframe{
      display:grid;
      grid-template-columns: 1fr calc(16px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
      height: calc(220px * var(--scale));
    }
    .scrollframe .pane{
      padding: calc(10px * var(--scale));
      overflow:auto;
      user-select:text;
    }
    .scrollframe .bar{
      border-left: var(--winBorder) solid var(--bw);
      background:
        repeating-linear-gradient(45deg, #fff 0 2px, #eee 2px 4px);
      position:relative;
    }
    .scrollframe .thumb{
      position:absolute;
      left:2px; right:2px;
      top: calc(22px * var(--scale));
      height: calc(44px * var(--scale));
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
    }

    .list{
      border: var(--winBorder) solid var(--bw);
      padding: calc(8px * var(--scale));
      background: var(--paper);
    }
    .list .item{
      display:flex; justify-content: space-between;
      padding: calc(4px * var(--scale)) calc(6px * var(--scale));
      cursor: default;
    }
    .list .item:hover{ background: var(--bw); color: var(--paper); }

    /* Dialog */
    .dialog{ width: calc(400px * var(--scale)); }
    .btnrow{
      display:flex; justify-content:flex-end; gap: calc(8px * var(--scale));
      margin-top: calc(10px * var(--scale));
    }
    .btn{
      border: var(--winBorder) solid var(--bw);
      background: var(--paper);
      padding: calc(6px * var(--scale)) calc(10px * var(--scale));
      cursor:pointer;
      font-size: calc(var(--ui) * var(--scale));
    }
    .btn:active{ transform: translateY(1px); }

    /* Calculator app */
    .calc{
      display:grid;
      gap: calc(10px * var(--scale));
    }
    .calc-display{
      border: var(--winBorder) solid var(--bw);
      background: #fff;
      padding: calc(8px * var(--scale)) calc(10px * var(--scale));
      font-size: calc(18px * var(--scale));
      font-weight: 700;
      text-align:right;
      letter-spacing: .02em;
      height: calc(36px * var(--scale));
      display:flex;
      align-items:center;
      justify-content:flex-end;
      overflow:hidden;
    }
    .calc-keys{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: calc(6px * var(--scale));
    }
    .key{
      border: var(--winBorder) solid var(--bw);
      background: #fff;
      padding: calc(8px * var(--scale)) 0;
      font-size: calc(13px * var(--scale));
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .key:active{ transform: translateY(1px); }
    .key.wide{ grid-column: span 2; }
    .key.op{ background: #fff; font-weight: 700; }
    .key.fn{ background: #fff; }

    /* 外部提示 */
    .outerTip{
      position: fixed;
      left: 18px;
      bottom: 14px;
      font-size: 12px;
      opacity: .88;
      color: rgba(255,255,255,.88);
      text-shadow: 0 2px 0 rgba(0,0,0,.55);
      pointer-events:none;
    }
    .outerTip code{
      background: rgba(0,0,0,.45);
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.20);
    }

    /* UI size modes */
    body.big .ui{ --scale: 1.25; }
    body.huge .ui{ --scale: 1.55; }
  </style>
</head>

<body>
  <div class="center">
    <div class="stageWrap" id="stageWrap">
      <div class="stage" id="stage">
        <div class="ui" id="ui">

          <!-- MENU BAR -->
          <div class="menubar" id="menubar">
            <div class="menu-left">
              <div class="apple" id="appleBtn" title=""></div>
              <div class="menu-item" data-menu="file">File</div>
              <div class="menu-item" data-menu="edit">Edit</div>
              <div class="menu-item" data-menu="view">View</div>
              <div class="menu-item" data-menu="special">Special</div>
            </div>
            <div class="menu-right">
              <div class="muted" id="clock">--:--</div>
            </div>
          </div>

          <!-- DROPDOWNS -->
          <div class="dropdown" id="dd-apple">
            <div class="row" data-action="about">About the Macintosh…</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="openFinder">Open Finder</div>
            <div class="row" data-action="openNote">Open Note Pad</div>
            <div class="row" data-action="openCalc">Open Calculator</div>
          </div>

          <div class="dropdown" id="dd-file">
            <div class="row" data-action="openFinder">Open</div>
            <div class="row" data-action="openNote">New Note</div>
            <div class="row" data-action="openCalc">Open Calculator</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="noteSave">Save Note <span class="kbd">⌘S</span></div>
            <div class="row" data-action="noteOpen">Open Note…</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="closeFront">Close <span class="kbd">⌘W</span></div>
          </div>

          <div class="dropdown" id="dd-edit">
            <div class="row" data-action="beep">Undo <span class="kbd">⌘Z</span></div>
            <div class="row" data-action="beep">Cut <span class="kbd">⌘X</span></div>
            <div class="row" data-action="beep">Copy <span class="kbd">⌘C</span></div>
            <div class="row" data-action="beep">Paste <span class="kbd">⌘V</span></div>
          </div>

          <div class="dropdown" id="dd-view">
            <div class="row" data-action="scaleNormal">Normal UI</div>
            <div class="row" data-action="scaleBig">Big UI</div>
            <div class="row" data-action="scaleHuge">Huge UI</div>
          </div>

          <div class="dropdown" id="dd-special">
            <div class="row" data-action="cleanup">Clean Up Desktop</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="restart">Restart…</div>
            <div class="row" data-action="shutdown">Shut Down…</div>
          </div>

          <!-- DESKTOP -->
          <div class="desktop" id="desktop">
            <div class="icon" id="icon-hd" data-open="finder" style="left: 24px; top: 24px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="6" y="6" width="24" height="24" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="10" width="16" height="8" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="22" width="16" height="6" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="13" y="24" width="3" height="2" fill="#000"/>
                  <rect x="20" y="24" width="3" height="2" fill="#000"/>
                </svg>
              </div>
              <div class="label">Macintosh HD</div>
            </div>

            <div class="icon" id="icon-note" data-open="note" style="left: 24px; top: 122px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="8" y="6" width="20" height="24" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="10" width="16" height="2" fill="#000"/>
                  <rect x="10" y="14" width="16" height="2" fill="#000"/>
                  <rect x="10" y="18" width="12" height="2" fill="#000"/>
                  <rect x="10" y="22" width="14" height="2" fill="#000"/>
                </svg>
              </div>
              <div class="label">Note Pad</div>
            </div>

            <div class="icon" id="icon-calc" data-open="calc" style="left: 24px; top: 220px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="9" y="6" width="18" height="24" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="11" y="9" width="14" height="6" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="11" y="18" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="16" y="18" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="21" y="18" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="11" y="23" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="16" y="23" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="21" y="23" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                </svg>
              </div>
              <div class="label">Calculator</div>
            </div>

            <div class="icon" id="icon-trash" data-open="trash" style="right: 22px; top: 24px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="12" y="10" width="12" height="20" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="10" width="16" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="14" y="14" width="2" height="14" fill="#000"/>
                  <rect x="20" y="14" width="2" height="14" fill="#000"/>
                </svg>
              </div>
              <div class="label">Trash</div>
            </div>
          </div>

          <!-- WINDOWS -->
          <div class="window visible" id="win-finder" style="left: 140px; top: 80px; width: 520px; height: 360px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-finder">×</div>
              <div class="wintitle">Finder</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="scrollframe" style="height: calc(100% - 2px);">
                <div class="pane">
                  <div class="muted">Macintosh HD</div>
                  <div style="height:8px"></div>
                  <div class="list" id="finderList">
                    <div class="item" data-open="about"><span>System Folder</span><span class="muted">Folder</span></div>
                    <div class="item" data-open="note"><span>Note Pad</span><span class="muted">Application</span></div>
                    <div class="item" data-open="calc"><span>Calculator</span><span class="muted">Application</span></div>
                    <div class="item" data-open="about"><span>Read Me</span><span class="muted">Text</span></div>
                  </div>
                  <div style="height:14px"></div>
                  <div class="muted">
                    Tip: 拖拽窗口/图标 · 右下角缩放 · Special → Clean Up Desktop
                  </div>
                </div>
                <div class="bar" aria-hidden="true"><div class="thumb"></div></div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-finder" title="Resize"></div>
          </div>

          <div class="window" id="win-note" style="left: 220px; top: 140px; width: 520px; height: 360px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-note">×</div>
              <div class="wintitle" id="noteTitle">Note Pad</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="scrollframe" style="height: calc(100% - 2px);">
                <div class="pane" style="padding:0; overflow:hidden;">
                  <textarea id="noteArea" style="
                    width:100%; height:100%;
                    border:0; outline:none;
                    padding: calc(10px * var(--scale));
                    resize:none;
                    font: inherit;
                    font-size: calc(var(--ui) * var(--scale));
                    line-height:1.45;
                    background: transparent;
                    color:#000;
                  ">Welcome to Macintosh.

This is a System 1-ish UI mock.

Try:
- Drag windows & icons
- Resize windows (bottom-right)
- File → Save/Open Note…

(Ctrl works as ⌘ on Windows.)</textarea>
                </div>
                <div class="bar" aria-hidden="true"><div class="thumb"></div></div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-note" title="Resize"></div>
          </div>

          <div class="window" id="win-calc" style="left: 520px; top: 140px; width: 300px; height: 360px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-calc">×</div>
              <div class="wintitle">Calculator</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="calc" style="height:100%;">
                <div class="calc-display" id="calcDisplay">0</div>
                <div class="calc-keys">
                  <div class="key fn" data-k="C">C</div>
                  <div class="key fn" data-k="BS">⌫</div>
                  <div class="key fn" data-k="%">%</div>
                  <div class="key op" data-k="/">÷</div>

                  <div class="key" data-k="7">7</div>
                  <div class="key" data-k="8">8</div>
                  <div class="key" data-k="9">9</div>
                  <div class="key op" data-k="*">×</div>

                  <div class="key" data-k="4">4</div>
                  <div class="key" data-k="5">5</div>
                  <div class="key" data-k="6">6</div>
                  <div class="key op" data-k="-">−</div>

                  <div class="key" data-k="1">1</div>
                  <div class="key" data-k="2">2</div>
                  <div class="key" data-k="3">3</div>
                  <div class="key op" data-k="+">+</div>

                  <div class="key wide" data-k="0">0</div>
                  <div class="key" data-k=".">.</div>
                  <div class="key op" data-k="=">=</div>
                </div>
                <div class="muted" style="font-size: calc(10px * var(--scale)); line-height:1.4;">
                  Keyboard: 0-9 . + - * / Enter (=) Backspace (⌫) Esc (C)
                </div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-calc" title="Resize"></div>
          </div>

          <div class="window dialog" id="win-about" style="left: 270px; top: 120px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-about">×</div>
              <div class="wintitle">About the Macintosh</div>
            </div>
            <div class="content">
              <div style="display:flex; gap:12px; align-items:flex-start;">
                <div style="width:64px; height:64px; border:var(--winBorder) solid #000; background:#fff; display:grid; place-items:center;">
                  <div style="font-weight:700; font-size: 26px;"></div>
                </div>
                <div>
                  <div style="font-weight:700; margin-bottom:6px;">Macintosh</div>
                  <div class="muted">System 1 style mock (HTML/CSS/JS)</div>
                  <div style="height:8px"></div>
                  <div>Enhancements: pixel+dither, icon drag/snap, window snap/resize</div>
                  <div>Apps: Note (localStorage), Calculator (working)</div>
                </div>
              </div>
              <div class="btnrow">
                <button class="btn" data-action="closeAbout">OK</button>
              </div>
            </div>
          </div>

          <div class="window dialog" id="win-trash" style="left: 360px; top: 160px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-trash">×</div>
              <div class="wintitle">Trash</div>
            </div>
            <div class="content">
              <div class="muted">Trash is empty.</div>
              <div class="btnrow">
                <button class="btn" data-close="win-trash">Close</button>
              </div>
            </div>
          </div>

          <div class="window dialog" id="win-open" style="left: 260px; top: 160px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-open">×</div>
              <div class="wintitle">Open</div>
            </div>
            <div class="content">
              <div class="muted">Select a document:</div>
              <div style="height:8px"></div>
              <div class="list" id="openList"></div>
              <div class="btnrow">
                <button class="btn" data-action="doOpen">Open</button>
                <button class="btn" data-close="win-open">Cancel</button>
              </div>
            </div>
          </div>

          <div class="window dialog" id="win-alert" style="left: 280px; top: 200px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-alert">×</div>
              <div class="wintitle" id="alertTitle">Alert</div>
            </div>
            <div class="content">
              <div id="alertMsg">Message</div>
              <div class="btnrow">
                <button class="btn" data-close="win-alert">OK</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="outerTip">
    拖拽图标/窗口 · 边缘吸附 & 网格对齐 · <code>Ctrl+S</code> 保存 Note · <code>Ctrl+W</code> 关闭前台
  </div>

  <script>
    // ===== Fit stage to viewport while keeping fixed logical size =====
    (function fitStage(){
      const stageW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--stageW')) || 900;
      const stageH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--stageH')) || 640;

      function apply(){
        const pad = 48;
        const vw = window.innerWidth - pad;
        const vh = window.innerHeight - pad;
        const s = Math.min(vw / stageW, vh / stageH, 1);
        document.documentElement.style.setProperty('--fit', s.toFixed(4));
      }
      window.addEventListener('resize', apply);
      apply();
    })();

    // Helpers
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
    const ui = $("#ui");
    const stage = $("#stage");
    const desktop = $("#desktop");

    let zTop = 50;
    let frontWin = null;
    let activeMenu = null;

    function getFit(){
      return parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--fit')) || 1;
    }
    function getScale(){
      return parseFloat(getComputedStyle(ui).getPropertyValue('--scale')) || 1;
    }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function snap(n, step){ return Math.round(n / step) * step; }
    function stageRect(){ return stage.getBoundingClientRect(); }

    // Clock
    function pad2(n){ return String(n).padStart(2,"0"); }
    setInterval(() => {
      const d = new Date();
      $("#clock").textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }, 500);

    // Beep
    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "square"; o.frequency.value = 740;
        g.gain.value = 0.03;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(() => { o.stop(); ctx.close(); }, 90);
      }catch(e){}
    }

    // Window manager
    function setFront(win){
      if(!win) return;
      $$(".window", ui).forEach(w => w.classList.add("inactive"));
      win.classList.remove("inactive");
      zTop += 1;
      win.style.zIndex = zTop;
      frontWin = win;
    }
    function showWin(id){
      const win = document.getElementById(id);
      if(!win) return;
      win.classList.add("visible");
      setFront(win);
    }
    function hideWin(id){
      const win = document.getElementById(id);
      if(!win) return;
      win.classList.remove("visible");
      if(frontWin === win) frontWin = null;
      const vis = $$(".window.visible", ui);
      if(vis.length) setFront(vis[vis.length-1]);
    }

    // Close buttons
    $$(".closebox", ui).forEach(btn => {
      btn.addEventListener("click", (e) => {
        const id = btn.getAttribute("data-close");
        if(id) hideWin(id);
        e.stopPropagation();
      });
    });
    // Bring window to front
    $$(".window", ui).forEach(win => win.addEventListener("pointerdown", () => setFront(win)));

    // Window dragging + snapping
    let drag = null;
    function onPointerDownTitle(e){
      const win = e.currentTarget.closest(".window");
      if(e.target.closest(".closebox")) return;
      setFront(win);

      const sr = stageRect();
      const rect = win.getBoundingClientRect();
      const fit = getFit();

      drag = {
        win,
        startX: e.clientX,
        startY: e.clientY,
        origL: (rect.left - sr.left) / fit,
        origT: (rect.top  - sr.top ) / fit,
        fit,
      };
      win.setPointerCapture?.(e.pointerId);
    }
    function onPointerMove(e){
      if(!drag) return;

      const fit = drag.fit;
      const dx = (e.clientX - drag.startX) / fit;
      const dy = (e.clientY - drag.startY) / fit;

      const w = drag.win;
      const sr = stageRect();
      const sw = sr.width / fit;
      const sh = sr.height / fit;

      const bw = w.offsetWidth;
      const bh = w.offsetHeight;

      const scale = getScale();
      const step = Math.max(6, Math.round(8 * scale));
      const snapDist = Math.max(10, Math.round(12 * scale));

      let left = drag.origL + dx;
      let top  = drag.origT + dy;

      // snap to edges
      if (Math.abs(left - 4) < snapDist) left = 4;
      if (Math.abs(top - (parseFloat(getComputedStyle(ui).getPropertyValue('--barH')) + 4)) < snapDist) {
        top = parseFloat(getComputedStyle(ui).getPropertyValue('--barH')) + 4;
      }
      const maxL = sw - bw - 4;
      const maxT = sh - bh - 4;
      if (Math.abs(left - maxL) < snapDist) left = maxL;
      if (Math.abs(top - maxT) < snapDist) top = maxT;

      // grid snap
      left = snap(left, step);
      top  = snap(top, step);

      left = clamp(left, 4, maxL);
      top  = clamp(top, parseFloat(getComputedStyle(ui).getPropertyValue('--barH')) + 4, maxT);

      w.style.left = left + "px";
      w.style.top  = top + "px";
    }
    function onPointerUp(){ drag = null; }
    $$(".window .titlebar", ui).forEach(tb => tb.addEventListener("pointerdown", onPointerDownTitle));
    window.addEventListener("pointermove", onPointerMove);
    window.addEventListener("pointerup", onPointerUp);

    // Window resizing + snapping
    let resize = null;
    function onPointerDownResize(e){
      const id = e.currentTarget.getAttribute("data-resize");
      const win = document.getElementById(id);
      if(!win) return;
      setFront(win);

      const sr = stageRect();
      const rect = win.getBoundingClientRect();
      const fit = getFit();

      resize = {
        win,
        startX: e.clientX,
        startY: e.clientY,
        origW: rect.width / fit,
        origH: rect.height / fit,
        left: (rect.left - sr.left) / fit,
        top:  (rect.top  - sr.top ) / fit,
        fit
      };
      win.setPointerCapture?.(e.pointerId);
      e.stopPropagation();
    }
    function onPointerMoveResize(e){
      if(!resize) return;

      const fit = resize.fit;
      const dx = (e.clientX - resize.startX) / fit;
      const dy = (e.clientY - resize.startY) / fit;

      const sr = stageRect();
      const sw = sr.width / fit;
      const sh = sr.height / fit;

      const w = resize.win;
      const minW = parseFloat(getComputedStyle(w).minWidth) || 240;
      const minH = parseFloat(getComputedStyle(w).minHeight) || 130;

      const scale = getScale();
      const step = Math.maxs = Math.max(6, Math.round(8 * scale));

      const maxW = sw - resize.left - 4;
      const maxH = sh - resize.top - 4;

      let nw = clamp(resize.origW + dx, minW, maxW);
      let nh = clamp(resize.origH + dy, minH, maxH);

      // grid snap for size
      nw = snap(nw, step);
      nh = snap(nh, step);

      nw = clamp(nw, minW, maxW);
      nh = clamp(nh, minH, maxH);

      w.style.width = nw + "px";
      w.style.height = nh + "px";
    }
    function onPointerUpResize(){ resize = null; }
    $$(".resize-handle", ui).forEach(h => h.addEventListener("pointerdown", onPointerDownResize));
    window.addEventListener("pointermove", onPointerMoveResize);
    window.addEventListener("pointerup", onPointerUpResize);

    // Desktop icon selection + open
    function clearIconSelection(){ $$(".icon", ui).forEach(i => i.classList.remove("selected")); }
    desktop.addEventListener("pointerdown", (e) => {
      if(!e.target.closest(".icon") && !e.target.closest(".window")){
        clearIconSelection();
        closeMenus();
      }
    });

    // Icon dragging + snapping
    let iconDrag = null;
    function onPointerDownIcon(e){
      const icon = e.currentTarget;
      clearIconSelection();
      icon.classList.add("selected");

      const fit = getFit();
      const sr = stageRect();
      const rect = icon.getBoundingClientRect();

      iconDrag = {
        icon,
        startX: e.clientX,
        startY: e.clientY,
        origL: (rect.left - sr.left) / fit,
        origT: (rect.top  - sr.top ) / fit,
        fit
      };
      icon.setPointerCapture?.(e.pointerId);
      e.preventDefault();
    }
    function onPointerMoveIcon(e){
      if(!iconDrag) return;

      const fit = iconDrag.fit;
      const dx = (e.clientX - iconDrag.startX) / fit;
      const dy = (e.clientY - iconDrag.startY) / fit;

      const icon = iconDrag.icon;
      const sr = stageRect();
      const sw = sr.width / fit;
      const sh = sr.height / fit;

      const scale = getScale();
      const step = Math.max(8, Math.round(10 * scale));
      const topMin = parseFloat(getComputedStyle(ui).getPropertyValue('--barH')) + 10;

      const bw = icon.offsetWidth;
      const bh = icon.offsetHeight;

      let left = iconDrag.origL + dx;
      let top  = iconDrag.origT + dy;

      left = snap(left, step);
      top  = snap(top, step);

      left = clamp(left, 6, sw - bw - 6);
      top  = clamp(top, topMin, sh - bh - 6);

      icon.style.left = left + "px";
      icon.style.top  = top + "px";
    }
    function onPointerUpIcon(){ iconDrag = null; }

    $$(".icon", ui).forEach(icon => {
      icon.addEventListener("pointerdown", onPointerDownIcon);
      icon.addEventListener("pointermove", onPointerMoveIcon);
      icon.addEventListener("pointerup", onPointerUpIcon);

      icon.addEventListener("dblclick", () => {
        const open = icon.getAttribute("data-open");
        if(open) openThing(open);
      });
    });

    // Finder list open
    $("#finderList").addEventListener("dblclick", (e) => {
      const item = e.target.closest(".item");
      if(!item) return;
      const open = item.getAttribute("data-open");
      if(open) openThing(open);
    });

    function openThing(key){
      switch(key){
        case "finder": showWin("win-finder"); break;
        case "note": showWin("win-note"); setTimeout(()=>$("#noteArea")?.focus(), 50); break;
        case "calc": showWin("win-calc"); break;
        case "about": showWin("win-about"); break;
        case "trash": showWin("win-trash"); break;
        default: beep();
      }
    }

    // Menus
    const menus = {
      apple: $("#dd-apple"),
      file: $("#dd-file"),
      edit: $("#dd-edit"),
      view: $("#dd-view"),
      special: $("#dd-special")
    };
    function closeMenus(){
      $$(".menu-item", ui).forEach(m => m.classList.remove("active"));
      Object.values(menus).forEach(dd => dd.style.display = "none");
      activeMenu = null;
      $("#appleBtn").style.background = "";
      $("#appleBtn").style.color = "";
    }
    function openMenu(name, anchorEl){
      closeMenus();
      activeMenu = name;

      if(anchorEl.classList.contains("menu-item")) anchorEl.classList.add("active");
      if(name === "apple"){
        $("#appleBtn").style.background = "#000";
        $("#appleBtn").style.color = "#fff";
      }

      const dd = menus[name];
      if(!dd) return;

      const sr = stageRect();
      const r = anchorEl.getBoundingClientRect();
      const fit = getFit();
      dd.style.left = Math.max(6, (r.left - sr.left) / fit) + "px";
      dd.style.display = "block";
    }
    $("#appleBtn").addEventListener("click", (e) => {
      if(activeMenu === "apple"){ closeMenus(); return; }
      openMenu("apple", e.currentTarget);
      e.stopPropagation();
    });
    $$(".menu-item", ui).forEach(mi => {
      mi.addEventListener("click", (e) => {
        const name = mi.getAttribute("data-menu");
        if(activeMenu === name){ closeMenus(); return; }
        openMenu(name, mi);
        e.stopPropagation();
      });
    });
    ui.addEventListener("pointerdown", (e) => {
      if(e.target.closest(".dropdown") || e.target.closest(".menubar")) return;
      closeMenus();
    });

    // Dialog helpers
    function alertBox(title, msg){
      $("#alertTitle").textContent = title;
      $("#alertMsg").textContent = msg;
      showWin("win-alert");
    }

    // Note "disk" (localStorage)
    const NOTE_KEY = "mac1_note_text";
    const NOTE_TIME = "mac1_note_time";
    function hasSavedNote(){ return localStorage.getItem(NOTE_KEY) != null; }
    function saveNote(){
      const txt = $("#noteArea")?.value ?? "";
      localStorage.setItem(NOTE_KEY, txt);
      localStorage.setItem(NOTE_TIME, new Date().toISOString());
      $("#noteTitle").textContent = "Note Pad — Saved";
      alertBox("Save", "Document saved to disk.");
    }
    function openNoteDialog(){
      const list = $("#openList");
      list.innerHTML = "";
      const saved = hasSavedNote();
      const time = localStorage.getItem(NOTE_TIME);

      const items = [
        { id:"factory", name:"Welcome Note", meta:"Text" },
        ...(saved ? [{ id:"saved", name:"Saved Note", meta: time ? ("Saved " + new Date(time).toLocaleString()) : "Saved" }] : [])
      ];

      items.forEach((it, idx) => {
        const div = document.createElement("div");
        div.className = "item";
        div.dataset.openId = it.id;
        div.innerHTML = `<span>${it.name}</span><span class="muted">${it.meta}</span>`;
        div.addEventListener("click", () => {
          $$("#openList .item").forEach(x => { x.style.background = ""; x.style.color = ""; });
          div.style.background = "#000";
          div.style.color = "#fff";
          list.dataset.selected = it.id;
        });
        if(idx === 0){
          list.dataset.selected = it.id;
          div.style.background = "#000"; div.style.color = "#fff";
        }
        list.appendChild(div);
      });

      showWin("win-open");
      setFront($("#win-open"));
    }
    function doOpen(){
      const sel = $("#openList").dataset.selected || "factory";
      showWin("win-note");
      if(sel === "factory"){
        $("#noteArea").value =
`Welcome to Macintosh.

Use File → Save Note to store this note.
Use File → Open Note… to load it back.

(You can type here.)`;
        $("#noteTitle").textContent = "Note Pad";
      }else if(sel === "saved"){
        const txt = localStorage.getItem(NOTE_KEY);
        if(txt == null){
          alertBox("Open", "No saved document found.");
        }else{
          $("#noteArea").value = txt;
          $("#noteTitle").textContent = "Note Pad — Saved";
        }
      }
      hideWin("win-open");
      $("#noteArea")?.focus();
    }

    // Clean up desktop (真正排列图标)
    function cleanUpDesktop(){
      const scale = getScale();
      const fit = getFit();
      const sr = stageRect();
      const sw = sr.width / fit;
      const sh = sr.height / fit;

      const topMin = parseFloat(getComputedStyle(ui).getPropertyValue('--barH')) + 10;
      const leftX = 24;
      const rightX = sw - (76 * scale) - 26;
      const stepY = Math.round(96 * scale);
      const stepX = Math.round(92 * scale);

      const icons = $$(".icon", ui);
      const trash = $("#icon-trash");

      // trash 固定右上
      if(trash){
        trash.style.left = rightX + "px";
        trash.style.top = (topMin + 14) + "px";
      }

      // 其他按列从左往下排
      let x = leftX;
      let y = topMin + 14;
      icons
        .filter(i => i !== trash)
        .sort((a,b) => a.id.localeCompare(b.id))
        .forEach(icon => {
          icon.style.left = x + "px";
          icon.style.top  = y + "px";
          y += stepY;
          if(y > sh - 120){
            y = topMin + 14;
            x += stepX;
          }
        });

      beep();
    }

    // Dropdown actions
    function restoreAbout(){
      $("#win-about .wintitle").textContent = "About the Macintosh";
      $("#win-about .content").innerHTML = `
        <div style="display:flex; gap:12px; align-items:flex-start;">
          <div style="width:64px; height:64px; border:var(--winBorder) solid #000; background:#fff; display:grid; place-items:center;">
            <div style="font-weight:700; font-size: 26px;"></div>
          </div>
          <div>
            <div style="font-weight:700; margin-bottom:6px;">Macintosh</div>
            <div class="muted">System 1 style mock (HTML/CSS/JS)</div>
            <div style="height:8px"></div>
            <div>Apps: Note (localStorage), Calculator (working)</div>
          </div>
        </div>
        <div class="btnrow">
          <button class="btn" data-action="closeAbout">OK</button>
        </div>`;
      bindDialogButtons();
    }
    function bindDialogButtons(){
      $$("#win-about [data-action]").forEach(btn=>{
        btn.onclick = (e) => {
          applyAction(btn.getAttribute("data-action"));
          e.stopPropagation();
        };
      });
    }
    bindDialogButtons();

    function applyAction(act){
      switch(act){
        case "about": showWin("win-about"); break;
        case "openFinder": showWin("win-finder"); break;
        case "openNote":
          showWin("win-note");
          $("#noteTitle").textContent = "Note Pad";
          setTimeout(()=>$("#noteArea")?.focus(), 50);
          break;
        case "openCalc":
          showWin("win-calc");
          break;
        case "noteSave":
          showWin("win-note");
          saveNote();
          break;
        case "noteOpen":
          openNoteDialog();
          break;
        case "doOpen":
          doOpen();
          break;
        case "cleanup":
          cleanUpDesktop();
          break;
        case "closeFront":
          if(frontWin) hideWin(frontWin.id); else beep();
          break;
        case "scaleNormal":
          document.body.classList.remove("big","huge");
          break;
        case "scaleBig":
          document.body.classList.remove("huge");
          document.body.classList.add("big");
          break;
        case "scaleHuge":
          document.body.classList.remove("big");
          document.body.classList.add("huge");
          break;
        case "restart":
          beep();
          alertBox("Restart", "Pretend restart complete.");
          // 简单重置窗口可见性
          $$(".window", ui).forEach(w => w.classList.remove("visible"));
          setTimeout(() => { showWin("win-finder"); }, 180);
          break;
        case "shutdown":
          beep();
          alertBox("Shut Down", "It is now safe to close this tab.");
          break;
        case "closeAbout":
          restoreAbout();
          hideWin("win-about");
          break;
        case "beep":
        default:
          beep();
      }
    }

    $$(".dropdown", ui).forEach(dd => {
      dd.addEventListener("click", (e) => {
        const row = e.target.closest(".row");
        if(!row) return;
        const act = row.getAttribute("data-action");
        if(act && act !== "sep"){
          applyAction(act);
          closeMenus();
        }
      });
    });

    // Open dialog buttons
    $$("#win-open [data-action]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        applyAction(btn.getAttribute("data-action"));
        e.stopPropagation();
      });
    });

    // Keyboard shortcuts: Windows用Ctrl模拟⌘
    window.addEventListener("keydown", (e) => {
      const cmd = e.ctrlKey || e.metaKey;

      if(cmd && (e.key === "w" || e.key === "W")){
        e.preventDefault();
        if(frontWin) hideWin(frontWin.id); else beep();
      }
      if(cmd && (e.key === "s" || e.key === "S")){
        e.preventDefault();
        showWin("win-note");
        saveNote();
      }
      if(e.key === "Escape"){
        closeMenus();
        clearIconSelection();
        // calc clear (optional)
      }
    });

    // ===== Calculator logic (真正可用) =====
    const calcDisplay = $("#calcDisplay");
    const calcWin = $("#win-calc");
    let calcState = {
      display: "0",
      first: null,
      op: null,
      waiting: false
    };

    function calcRender(){
      // 限制长度，像老计算器一样裁剪
      const s = calcState.display;
      calcDisplay.textContent = (s.length > 14) ? s.slice(0, 14) : s;
    }

    function calcClear(){
      calcState = { display:"0", first:null, op:null, waiting:false };
      calcRender();
    }

    function calcBackspace(){
      if(calcState.waiting) return;
      const s = calcState.display;
      if(s.length <= 1) calcState.display = "0";
      else calcState.display = s.slice(0, -1);
      calcRender();
    }

    function calcInputDigit(d){
      if(calcState.waiting){
        calcState.display = d;
        calcState.waiting = false;
      }else{
        calcState.display = (calcState.display === "0") ? d : (calcState.display + d);
      }
      calcRender();
    }

    function calcInputDot(){
      if(calcState.waiting){
        calcState.display = "0.";
        calcState.waiting = false;
        calcRender();
        return;
      }
      if(!calcState.display.includes(".")){
        calcState.display += ".";
        calcRender();
      }
    }

    function calcPercent(){
      const v = parseFloat(calcState.display);
      if(!Number.isFinite(v)) return;
      calcState.display = String(v / 100);
      calcRender();
    }

    function calcToggleSign(){
      const v = parseFloat(calcState.display);
      if(!Number.isFinite(v)) return;
      calcState.display = String(-v);
      calcRender();
    }

    function calcCompute(a, b, op){
      if(op === "+") return a + b;
      if(op === "-") return a - b;
      if(op === "*") return a * b;
      if(op === "/") return (b === 0) ? NaN : (a / b);
      return b;
    }

    function calcOperator(nextOp){
      const input = parseFloat(calcState.display);

      if(calcState.first == null){
        calcState.first = input;
      }else if(calcState.op && !calcState.waiting){
        const result = calcCompute(calcState.first, input, calcState.op);
        if(!Number.isFinite(result)){
          calcState.display = "Error";
          calcState.first = null;
          calcState.op = null;
          calcState.waiting = true;
          calcRender();
          return;
        }
        calcState.first = result;
        calcState.display = String(result);
      }

      calcState.op = nextOp;
      calcState.waiting = true;
      calcRender();
    }

    function calcEquals(){
      const input = parseFloat(calcState.display);
      if(calcState.op == null || calcState.first == null || calcState.waiting) return;

      const result = calcCompute(calcState.first, input, calcState.op);
      if(!Number.isFinite(result)){
        calcState.display = "Error";
      }else{
        calcState.display = String(result);
      }
      calcState.first = null;
      calcState.op = null;
      calcState.waiting = true;
      calcRender();
    }

    function calcPress(k){
      if(k >= "0" && k <= "9") return calcInputDigit(k);
      if(k === ".") return calcInputDot();
      if(k === "C") return calcClear();
      if(k === "BS") return calcBackspace();
      if(k === "%") return calcPercent();
      if(k === "±") return calcToggleSign();
      if(k === "+" || k === "-" || k === "*" || k === "/") return calcOperator(k);
      if(k === "=") return calcEquals();
    }

    // Calculator button events
    $("#win-calc").addEventListener("click", (e) => {
      const btn = e.target.closest(".key");
      if(!btn) return;
      const k = btn.getAttribute("data-k");
      if(k) calcPress(k);
    });

    // Calculator keyboard input (仅当前台窗口为 calc 时更像应用；这里简化：打开 calc 时也能用)
    window.addEventListener("keydown", (e) => {
      const calcVisible = $("#win-calc").classList.contains("visible");
      if(!calcVisible) return;

      const key = e.key;

      if(key >= "0" && key <= "9"){ e.preventDefault(); calcInputDigit(key); return; }
      if(key === "."){ e.preventDefault(); calcInputDot(); return; }
      if(key === "+" || key === "-" || key === "*" || key === "/"){ e.preventDefault(); calcOperator(key); return; }
      if(key === "Enter" || key === "="){ e.preventDefault(); calcEquals(); return; }
      if(key === "Backspace"){ e.preventDefault(); calcBackspace(); return; }
      if(key === "Escape"){ e.preventDefault(); calcClear(); return; }
      if(key === "%"){ e.preventDefault(); calcPercent(); return; }
    });

    // Init
    showWin("win-finder");
    setFront($("#win-finder"));
    calcRender();
  </script>
</body>
</html>
