<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Macintosh (System 1) Mock · Touch + Pinch Zoom</title>
  <style>
    :root{
      --stageW: 900;
      --stageH: 640;

      /* base fit (auto) * userZoom = --fit */
      --fit: 1;

      --scale: 1.0;
      --ui: 12px;
      --barH: calc(22px * var(--scale));
      --winBorder: 2px;

      --bw:#000;
      --paper:#fff;
      --desk1:#e9e9e9;
      --desk2:#d9d9d9;
      --shadow: rgba(0,0,0,.35);
      --sel:#000;
      --selText:#fff;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    html, body{
      margin:0;
      overflow:hidden;
      overscroll-behavior: none;
      touch-action: none;          /* prevent browser gestures */
      -webkit-user-select:none;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    body{
      background:
        radial-gradient(1200px 800px at 50% 40%, rgba(255,255,255,.12), transparent 55%),
        radial-gradient(900px 600px at 20% 70%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.18), transparent 20%, transparent 80%, rgba(0,0,0,.35)),
        repeating-linear-gradient(45deg, rgba(255,255,255,.06) 0 6px, rgba(0,0,0,.04) 6px 12px),
        radial-gradient(circle, rgba(0,0,0,.14) 1px, transparent 1px);
      background-size:auto,auto,auto,auto,6px 6px;

      font-family:"MS Gothic","SimSun",ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
      -webkit-font-smoothing:none;
      -moz-osx-font-smoothing:auto;
      text-rendering: optimizeSpeed;

      color:#fff;
    }

    .center{
      position:fixed; inset:0;
      display:grid; place-items:center;
      padding: max(8px, env(safe-area-inset-top)) max(8px, env(safe-area-inset-right))
               max(8px, env(safe-area-inset-bottom)) max(8px, env(safe-area-inset-left));
      touch-action:none;
    }

    /* The viewport transform (pan) lives here */
    .stageWrap{
      width: calc(var(--stageW) * 1px * var(--fit));
      height: calc(var(--stageH) * 1px * var(--fit));
      will-change: transform;
      filter:
        drop-shadow(0 26px 0 rgba(0,0,0,.35))
        drop-shadow(0 18px 38px rgba(0,0,0,.35));
      touch-action:none;
    }

    /* Scale lives on .stage (layout-safe on mobile) */
    .stage{
      width: calc(var(--stageW) * 1px);
      height: calc(var(--stageH) * 1px);
      position:relative;
      overflow:hidden;
      border:5px solid #000;
      background:#fff;
      filter:contrast(1.06);
      transform: scale(var(--fit));
      transform-origin: top left;
      touch-action:none;
    }

    .stage::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(to bottom, rgba(0,0,0,.07) 0 1px, transparent 1px 3px),
        radial-gradient(circle, rgba(0,0,0,.12) 1px, transparent 1px),
        radial-gradient(900px 600px at 50% 45%, rgba(0,0,0,.20), transparent 60%);
      background-size:auto,4px 4px,auto;
      opacity:.55;
      mix-blend-mode:multiply;
    }

    .ui{
      position:absolute; inset:0;
      background: repeating-linear-gradient(45deg, #e9e9e9 0 2px, #d9d9d9 2px 4px);
      color:#000;
      touch-action:none;
    }
    .ui::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle, rgba(0,0,0,.10) 1px, transparent 1px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.04) 0 1px, transparent 1px 6px);
      background-size:6px 6px,7px 7px;
      opacity:.16;
      mix-blend-mode:multiply;
    }

    .menubar{
      position:absolute; left:0; right:0; top:0;
      height: var(--barH);
      background:#fff;
      border-bottom: var(--winBorder) solid #000;
      display:flex;
      align-items:center;
      padding: 0 calc(8px * var(--scale));
      gap: calc(10px * var(--scale));
      z-index: 9999;
      font-size: calc(var(--ui) * var(--scale));
      line-height:1;
      touch-action:none;
    }
    .menu-left,.menu-right{ display:flex; align-items:center; gap: calc(10px * var(--scale)); }
    .menu-right{ margin-left:auto; gap: calc(12px * var(--scale)); }
    .apple{
      width: calc(16px * var(--scale));
      height: calc(16px * var(--scale));
      border: var(--winBorder) solid #000;
      display:grid; place-items:center;
      font-weight:700;
      font-size: calc(12px * var(--scale));
      cursor:pointer;
      background:transparent;
      touch-action:none;
    }
    .menu-item{
      padding: calc(3px * var(--scale)) calc(6px * var(--scale));
      cursor:pointer;
      border:1px solid transparent;
      touch-action:none;
    }
    .menu-item.active{ background:#000; color:#fff; }

    .dropdown{
      position:absolute;
      top: calc(var(--barH) - 1px);
      min-width: calc(240px * var(--scale));
      background:#fff;
      border: var(--winBorder) solid #000;
      box-shadow: 0 calc(8px * var(--scale)) 0 rgba(0,0,0,.35);
      display:none;
      z-index:9998;
      font-size: calc(var(--ui) * var(--scale));
      touch-action:none;
    }
    .dropdown .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: calc(8px * var(--scale)) calc(12px * var(--scale));
      border-bottom: 1px solid rgba(0,0,0,.2);
      cursor:pointer;
      touch-action:none;
    }
    .dropdown .row:last-child{ border-bottom:0; }
    .dropdown .row:hover{ background:#000; color:#fff; }
    .kbd{ opacity:.75; margin-left: calc(12px * var(--scale)); }
    .muted{ opacity:.7; }

    .desktop{
      position:absolute;
      left:0; right:0;
      top: var(--barH);
      bottom:0;
      padding: calc(14px * var(--scale));
      touch-action:none;
    }

    .icon{
      position:absolute;
      width: calc(76px * var(--scale));
      text-align:center;
      cursor: default;
      touch-action:none;
    }
    .icon .glyph{
      width: calc(36px * var(--scale));
      height: calc(36px * var(--scale));
      margin: 0 auto calc(6px * var(--scale));
      border: var(--winBorder) solid #000;
      background:#fff;
      display:grid; place-items:center;
      touch-action:none;
    }
    .icon .label{
      display:inline-block;
      padding: calc(2px * var(--scale)) calc(4px * var(--scale));
      font-size: calc(var(--ui) * var(--scale));
      line-height:1.15;
      background:transparent;
      color:#000;
      touch-action:none;
    }
    .icon.selected .label{ background:#000; color:#fff; }

    .window{
      position:absolute;
      background:#fff;
      border: var(--winBorder) solid #000;
      box-shadow: 0 calc(10px * var(--scale)) 0 rgba(0,0,0,.35);
      min-width: calc(240px * var(--scale));
      min-height: calc(130px * var(--scale));
      display:none;
      touch-action:none;
    }
    .window.visible{ display:block; }
    .window.inactive{ opacity:.95; }

    .titlebar{
      height: calc(22px * var(--scale));
      border-bottom: var(--winBorder) solid #000;
      display:flex;
      align-items:center;
      gap: calc(8px * var(--scale));
      padding: 0 calc(8px * var(--scale));
      cursor: move;
      background: repeating-linear-gradient(90deg, transparent 0 6px, rgba(0,0,0,.14) 6px 7px);
      touch-action:none;
    }
    .closebox{
      width: calc(16px * var(--scale));
      height: calc(16px * var(--scale));
      border: var(--winBorder) solid #000;
      background:#fff;
      cursor:pointer;
      flex:0 0 auto;
      display:grid; place-items:center;
      font-size: calc(12px * var(--scale));
      line-height:1;
      touch-action:none;
    }
    .wintitle{
      flex:1 1 auto;
      text-align:center;
      font-size: calc(var(--ui) * var(--scale));
      letter-spacing:.02em;
      font-weight:700;
      padding-right: calc(18px * var(--scale));
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .content{
      position:relative;
      padding: calc(10px * var(--scale));
      font-size: calc(var(--ui) * var(--scale));
      line-height:1.35;
    }

    .resize-handle{
      position:absolute;
      right: 2px;
      bottom: 2px;
      width: calc(16px * var(--scale));
      height: calc(16px * var(--scale));
      border-left: var(--winBorder) solid #000;
      border-top: var(--winBorder) solid #000;
      background: repeating-linear-gradient(135deg, transparent 0 3px, rgba(0,0,0,.22) 3px 4px);
      cursor:nwse-resize;
      touch-action:none;
    }
    .window.dialog .resize-handle{ display:none; }

    .scrollframe{
      display:grid;
      grid-template-columns: 1fr calc(16px * var(--scale));
      border: var(--winBorder) solid #000;
      background:#fff;
      height: calc(220px * var(--scale));
    }
    .scrollframe .pane{
      padding: calc(10px * var(--scale));
      overflow:auto;
      user-select:text;
      -webkit-user-select:text;
      touch-action: pan-y;
    }
    .scrollframe .bar{
      border-left: var(--winBorder) solid #000;
      background: repeating-linear-gradient(45deg, #fff 0 2px, #eee 2px 4px);
      position:relative;
    }
    .scrollframe .thumb{
      position:absolute;
      left:2px; right:2px;
      top: calc(22px * var(--scale));
      height: calc(44px * var(--scale));
      border: var(--winBorder) solid #000;
      background:#fff;
    }

    .list{
      border: var(--winBorder) solid #000;
      padding: calc(8px * var(--scale));
      background:#fff;
    }
    .list .item{
      display:flex;
      justify-content:space-between;
      padding: calc(6px * var(--scale)) calc(8px * var(--scale));
      cursor:default;
      touch-action:none;
    }
    .list .item:hover{ background:#000; color:#fff; }

    .dialog{ width: calc(420px * var(--scale)); }
    .btnrow{
      display:flex;
      justify-content:flex-end;
      gap: calc(8px * var(--scale));
      margin-top: calc(10px * var(--scale));
    }
    .btn{
      border: var(--winBorder) solid #000;
      background:#fff;
      padding: calc(8px * var(--scale)) calc(12px * var(--scale));
      cursor:pointer;
      font-size: calc(var(--ui) * var(--scale));
      touch-action:none;
    }

    /* Calculator + Player trimmed for brevity (same as prior) */
    .calc{ display:grid; gap: calc(10px * var(--scale)); }
    .calc-display{ border:2px solid #000; padding: calc(8px * var(--scale)) calc(10px * var(--scale)); font-size: calc(18px * var(--scale)); font-weight:700; text-align:right; height: calc(36px * var(--scale)); display:flex; align-items:center; justify-content:flex-end; overflow:hidden; user-select:text; -webkit-user-select:text; background:#fff; }
    .calc-keys{ display:grid; grid-template-columns: repeat(4, 1fr); gap: calc(6px * var(--scale)); }
    .key{ border:2px solid #000; background:#fff; padding: calc(12px * var(--scale)) 0; font-size: calc(13px * var(--scale)); cursor:pointer; text-align:center; user-select:none; touch-action:none; }
    .key.wide{ grid-column: span 2; }
    .key.op{ font-weight:700; }
    .key:active, .btn:active{ transform: translateY(1px); }

    .player{ display:grid; gap: calc(10px * var(--scale)); }
    .player-head{ border:2px solid #000; padding: calc(8px * var(--scale)); background:#fff; display:grid; gap: calc(6px * var(--scale)); }
    .trackline{ display:flex; justify-content:space-between; gap: calc(10px * var(--scale)); align-items:center; font-weight:700; }
    .trackline .name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .time{ display:flex; justify-content:space-between; font-size: calc(11px * var(--scale)); }
    .controls{ display:flex; gap: calc(8px * var(--scale)); align-items:center; }
    .range{ width:100%; -webkit-appearance:none; appearance:none; height: calc(18px * var(--scale)); background:#fff; border:2px solid #000; outline:none; margin:0; touch-action: pan-x; }
    .range::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width: calc(14px * var(--scale)); height: calc(20px * var(--scale)); border:2px solid #000; background:#fff; cursor:pointer; }
    .player-note{ font-size: calc(11px * var(--scale)); }

    .outerTip{
      position:fixed; left:12px; right:12px; bottom:10px;
      font-size:12px; opacity:.9; color: rgba(255,255,255,.9);
      text-shadow: 0 2px 0 rgba(0,0,0,.55);
      pointer-events:none;
    }
    .outerTip code{ background: rgba(0,0,0,.45); padding: 2px 6px; border-radius:6px; border: 1px solid rgba(255,255,255,.20); }

    body.big .ui{ --scale: 1.25; }
    body.huge .ui{ --scale: 1.55; }
  </style>
</head>

<body>
  <div class="center" id="center">
    <div class="stageWrap" id="stageWrap">
      <div class="stage" id="stage">
        <div class="ui" id="ui">

          <div class="menubar" id="menubar">
            <div class="menu-left">
              <div class="apple" id="appleBtn" title=""></div>
              <div class="menu-item" data-menu="file">File</div>
              <div class="menu-item" data-menu="edit">Edit</div>
              <div class="menu-item" data-menu="view">View</div>
              <div class="menu-item" data-menu="special">Special</div>
            </div>
            <div class="menu-right">
              <div class="muted" id="clock">--:--</div>
            </div>
          </div>

          <div class="dropdown" id="dd-apple">
            <div class="row" data-action="about">About the Macintosh…</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="openFinder">Open Finder</div>
            <div class="row" data-action="openNote">Open Note Pad</div>
            <div class="row" data-action="openCalc">Open Calculator</div>
            <div class="row" data-action="openMusic">Open Music Player</div>
          </div>

          <div class="dropdown" id="dd-file">
            <div class="row" data-action="openFinder">Open</div>
            <div class="row" data-action="openNote">New Note</div>
            <div class="row" data-action="openCalc">Open Calculator</div>
            <div class="row" data-action="openMusic">Open Music Player</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="noteSave">Save Note <span class="kbd">⌘S</span></div>
            <div class="row" data-action="noteOpen">Open Note…</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="closeFront">Close <span class="kbd">⌘W</span></div>
          </div>

          <div class="dropdown" id="dd-edit">
            <div class="row" data-action="beep">Undo <span class="kbd">⌘Z</span></div>
            <div class="row" data-action="beep">Cut <span class="kbd">⌘X</span></div>
            <div class="row" data-action="beep">Copy <span class="kbd">⌘C</span></div>
            <div class="row" data-action="beep">Paste <span class="kbd">⌘V</span></div>
          </div>

          <div class="dropdown" id="dd-view">
            <div class="row" data-action="scaleNormal">Normal UI</div>
            <div class="row" data-action="scaleBig">Big UI</div>
            <div class="row" data-action="scaleHuge">Huge UI</div>
          </div>

          <div class="dropdown" id="dd-special">
            <div class="row" data-action="cleanup">Clean Up Desktop</div>
            <div class="row" data-action="sep" style="pointer-events:none; opacity:.6;">────────────</div>
            <div class="row" data-action="restart">Restart…</div>
            <div class="row" data-action="shutdown">Shut Down…</div>
          </div>

          <div class="desktop" id="desktop">
            <!-- icons -->
            <div class="icon" id="icon-hd" data-open="finder" style="left:24px; top:24px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="6" y="6" width="24" height="24" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="10" width="16" height="8" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="22" width="16" height="6" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="13" y="24" width="3" height="2" fill="#000"/>
                  <rect x="20" y="24" width="3" height="2" fill="#000"/>
                </svg>
              </div>
              <div class="label">Macintosh HD</div>
            </div>

            <div class="icon" id="icon-note" data-open="note" style="left:24px; top:122px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="8" y="6" width="20" height="24" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="10" width="16" height="2" fill="#000"/>
                  <rect x="10" y="14" width="16" height="2" fill="#000"/>
                  <rect x="10" y="18" width="12" height="2" fill="#000"/>
                  <rect x="10" y="22" width="14" height="2" fill="#000"/>
                </svg>
              </div>
              <div class="label">Note Pad</div>
            </div>

            <div class="icon" id="icon-calc" data-open="calc" style="left:24px; top:220px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="9" y="6" width="18" height="24" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="11" y="9" width="14" height="6" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="11" y="18" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="16" y="18" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="21" y="18" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="11" y="23" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="16" y="23" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="21" y="23" width="4" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                </svg>
              </div>
              <div class="label">Calculator</div>
            </div>

            <div class="icon" id="icon-music" data-open="music" style="left:24px; top:318px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="8" y="7" width="20" height="22" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="12" y="11" width="10" height="2" fill="#000"/>
                  <rect x="12" y="15" width="14" height="2" fill="#000"/>
                  <rect x="12" y="19" width="12" height="2" fill="#000"/>
                  <rect x="12" y="23" width="8"  height="2" fill="#000"/>
                  <circle cx="24" cy="24" r="2" fill="#000"/>
                  <rect x="25" y="12" width="2" height="12" fill="#000"/>
                </svg>
              </div>
              <div class="label">Music</div>
            </div>

            <div class="icon" id="icon-trash" data-open="trash" style="left:792px; top:24px;">
              <div class="glyph" aria-hidden="true">
                <svg width="100%" height="100%" viewBox="0 0 36 36" shape-rendering="crispEdges">
                  <rect x="12" y="10" width="12" height="20" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="10" y="10" width="16" height="4" fill="#fff" stroke="#000" stroke-width="2"/>
                  <rect x="14" y="14" width="2" height="14" fill="#000"/>
                  <rect x="20" y="14" width="2" height="14" fill="#000"/>
                </svg>
              </div>
              <div class="label">Trash</div>
            </div>
          </div>

          <!-- windows -->
          <div class="window visible" id="win-finder" style="left:140px; top:80px; width:540px; height:360px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-finder">×</div>
              <div class="wintitle">Finder</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="scrollframe" style="height: calc(100% - 2px);">
                <div class="pane">
                  <div class="muted">Macintosh HD</div>
                  <div style="height:8px"></div>
                  <div class="list" id="finderList">
                    <div class="item" data-open="about"><span>System Folder</span><span class="muted">Folder</span></div>
                    <div class="item" data-open="note"><span>Note Pad</span><span class="muted">Application</span></div>
                    <div class="item" data-open="calc"><span>Calculator</span><span class="muted">Application</span></div>
                    <div class="item" data-open="music"><span>Music Player</span><span class="muted">Application</span></div>
                    <div class="item" data-open="about"><span>Read Me</span><span class="muted">Text</span></div>
                  </div>
                  <div style="height:12px"></div>
                  <div class="muted">Two-finger: pinch to zoom, drag to pan · One finger: drag icons/windows</div>
                </div>
                <div class="bar" aria-hidden="true"><div class="thumb"></div></div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-finder" title="Resize"></div>
          </div>

          <div class="window" id="win-note" style="left:220px; top:140px; width:520px; height:360px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-note">×</div>
              <div class="wintitle" id="noteTitle">Note Pad</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="scrollframe" style="height: calc(100% - 2px);">
                <div class="pane" style="padding:0; overflow:hidden; touch-action: pan-y;">
                  <textarea id="noteArea" style="
                    width:100%; height:100%;
                    border:0; outline:none;
                    padding: calc(10px * var(--scale));
                    resize:none;
                    font: inherit;
                    font-size: calc(var(--ui) * var(--scale));
                    line-height:1.45;
                    background: transparent;
                    color:#000;
                    touch-action: pan-y;
                    -webkit-user-select:text;
                    user-select:text;
                  ">Pinch to zoom, drag (two fingers) to pan.

把 song.mp3 放在同目录。</textarea>
                </div>
                <div class="bar" aria-hidden="true"><div class="thumb"></div></div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-note" title="Resize"></div>
          </div>

          <div class="window" id="win-calc" style="left:540px; top:140px; width:300px; height:360px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-calc">×</div>
              <div class="wintitle">Calculator</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="calc" style="height:100%;">
                <div class="calc-display" id="calcDisplay">0</div>
                <div class="calc-keys">
                  <div class="key" data-k="C">C</div>
                  <div class="key" data-k="BS">⌫</div>
                  <div class="key" data-k="%">%</div>
                  <div class="key op" data-k="/">÷</div>

                  <div class="key" data-k="7">7</div>
                  <div class="key" data-k="8">8</div>
                  <div class="key" data-k="9">9</div>
                  <div class="key op" data-k="*">×</div>

                  <div class="key" data-k="4">4</div>
                  <div class="key" data-k="5">5</div>
                  <div class="key" data-k="6">6</div>
                  <div class="key op" data-k="-">−</div>

                  <div class="key" data-k="1">1</div>
                  <div class="key" data-k="2">2</div>
                  <div class="key" data-k="3">3</div>
                  <div class="key op" data-k="+">+</div>

                  <div class="key wide" data-k="0">0</div>
                  <div class="key" data-k=".">.</div>
                  <div class="key op" data-k="=">=</div>
                </div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-calc" title="Resize"></div>
          </div>

          <div class="window" id="win-music" style="left:420px; top:220px; width:420px; height:260px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-music">×</div>
              <div class="wintitle">Music Player</div>
            </div>
            <div class="content" style="height: calc(100% - (22px * var(--scale)));">
              <div class="player" style="height:100%;">
                <div class="player-head">
                  <div class="trackline">
                    <div class="name" id="musicName">song.mp3</div>
                    <div class="state" id="musicState">STOP</div>
                  </div>
                  <div class="time">
                    <div id="musicTime">0:00</div>
                    <div id="musicDur">0:00</div>
                  </div>
                  <input class="range" id="musicSeek" type="range" min="0" max="0" step="0.01" value="0" />
                </div>

                <div class="controls">
                  <button class="btn" id="musicPlay">Play</button>
                  <button class="btn" id="musicPause">Pause</button>
                  <div class="muted" style="margin-left:auto;" id="musicStatus">Ready</div>
                </div>

                <div class="player-note muted">
                  把 <b>song.mp3</b> 放在与本 HTML 同目录（GitHub Pages：仓库根目录）。
                </div>
              </div>
            </div>
            <div class="resize-handle" data-resize="win-music" title="Resize"></div>
          </div>

          <div class="window dialog" id="win-about" style="left:260px; top:120px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-about">×</div>
              <div class="wintitle">About the Macintosh</div>
            </div>
            <div class="content">
              <div style="display:flex; gap:12px; align-items:flex-start;">
                <div style="width:64px; height:64px; border:var(--winBorder) solid #000; background:#fff; display:grid; place-items:center;">
                  <div style="font-weight:700; font-size:26px;"></div>
                </div>
                <div>
                  <div style="font-weight:700; margin-bottom:6px;">Macintosh</div>
                  <div class="muted">Pinch to zoom + two-finger pan</div>
                </div>
              </div>
              <div class="btnrow">
                <button class="btn" data-action="closeAbout">OK</button>
              </div>
            </div>
          </div>

          <div class="window dialog" id="win-trash" style="left:360px; top:160px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-trash">×</div>
              <div class="wintitle">Trash</div>
            </div>
            <div class="content">
              <div class="muted">Trash is empty.</div>
              <div class="btnrow">
                <button class="btn" data-close="win-trash">Close</button>
              </div>
            </div>
          </div>

          <div class="window dialog" id="win-alert" style="left:280px; top:200px;">
            <div class="titlebar">
              <div class="closebox" data-close="win-alert">×</div>
              <div class="wintitle" id="alertTitle">Alert</div>
            </div>
            <div class="content">
              <div id="alertMsg">Message</div>
              <div class="btnrow">
                <button class="btn" data-close="win-alert">OK</button>
              </div>
            </div>
          </div>

        </div><!-- ui -->
      </div><!-- stage -->
    </div><!-- stageWrap -->
  </div><!-- center -->

  <div class="outerTip">
    ✅ 双指：缩放 + 拖动视图｜单指：拖图标/窗口｜音乐：<code>./song.mp3</code>
  </div>

  <script>
    const root = document.documentElement;
    const center = document.getElementById('center');
    const stageWrap = document.getElementById('stageWrap');
    const stage = document.getElementById('stage');
    const ui = document.getElementById('ui');
    const desktop = document.getElementById('desktop');

    const $  = (sel, r=document) => r.querySelector(sel);
    const $$ = (sel, r=document) => [...r.querySelectorAll(sel)];

    // ===== Viewport state: autoFit * userZoom, plus pan in CSS pixels =====
    const view = {
      baseFit: 1,
      userZoom: 1,
      panX: 0,
      panY: 0,
      minZoom: 0.6,
      maxZoom: 3.0,
    };

    function stageW(){ return parseFloat(getComputedStyle(root).getPropertyValue('--stageW')) || 900; }
    function stageH(){ return parseFloat(getComputedStyle(root).getPropertyValue('--stageH')) || 640; }

    function applyView(){
      const fit = view.baseFit * view.userZoom;
      root.style.setProperty('--fit', String(fit));

      // clamp pan so user doesn't lose the stage entirely
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const sw = stageW() * fit;
      const sh = stageH() * fit;

      // allow a bit of overscroll for feel
      const margin = 80;

      // centered by grid; pan is relative to center
      const maxPanX = Math.max(0, (sw + vw) / 2 - margin);
      const maxPanY = Math.max(0, (sh + vh) / 2 - margin);

      view.panX = Math.max(-maxPanX, Math.min(maxPanX, view.panX));
      view.panY = Math.max(-maxPanY, Math.min(maxPanY, view.panY));

      stageWrap.style.transform = `translate(${view.panX}px, ${view.panY}px)`;
    }

    function computeBaseFit(){
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const pad = 16;
      const s = Math.min((vw - pad) / stageW(), (vh - pad) / stageH(), 1);
      view.baseFit = Math.max(0.1, s);
    }

    function resetView(){
      computeBaseFit();
      view.userZoom = 1;
      view.panX = 0;
      view.panY = 0;
      applyView();
    }

    window.addEventListener('resize', () => { computeBaseFit(); applyView(); });
    window.addEventListener('orientationchange', () => { computeBaseFit(); applyView(); });

    // ===== Gestures: pinch zoom + two-finger pan; one-finger pan on background =====
    const pointers = new Map(); // id -> {x,y, targetInteractive:boolean}
    let gesture = null; // {mode, prevMidX, prevMidY, prevDist, prevEff}

    function isInteractiveTarget(t){
      // If user starts on icon/window/menu/inputs, do NOT treat as viewport pan
      if(!t) return false;
      return !!(t.closest('.icon') || t.closest('.window') || t.closest('.menubar') || t.closest('.dropdown') || t.closest('input, textarea, button, .pane'));
    }

    function dist2(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
    function mid2(a,b){ return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; }

    function effFit(){ return view.baseFit * view.userZoom; }

    center.addEventListener('pointerdown', (e) => {
      pointers.set(e.pointerId, { x:e.clientX, y:e.clientY, interactive:isInteractiveTarget(e.target) });
      // capture to keep receiving moves even if finger leaves
      center.setPointerCapture?.(e.pointerId);

      // Start gesture when two pointers are down AND neither started on interactive controls
      if(pointers.size === 2){
        const pts = [...pointers.values()];
        if(!pts[0].interactive && !pts[1].interactive){
          const m = mid2(pts[0], pts[1]);
          gesture = {
            mode: 'pinch',
            prevMidX: m.x,
            prevMidY: m.y,
            prevDist: dist2(pts[0], pts[1]),
            prevEff: effFit(),
          };
        }
      }else if(pointers.size === 1){
        const p = pointers.get(e.pointerId);
        // One-finger pan only if NOT on interactive elements
        if(p && !p.interactive){
          gesture = {
            mode: 'pan',
            prevMidX: p.x,
            prevMidY: p.y,
            prevEff: effFit(),
          };
        }
      }
    }, { passive:false });

    center.addEventListener('pointermove', (e) => {
      const p = pointers.get(e.pointerId);
      if(!p) return;
      p.x = e.clientX; p.y = e.clientY;

      if(!gesture) return;

      if(gesture.mode === 'pinch' && pointers.size >= 2){
        const [a,b] = [...pointers.values()];
        if(a.interactive || b.interactive) return;

        const m = mid2(a,b);
        const d = dist2(a,b);
        const oldEff = gesture.prevEff;

        // pan by midpoint delta
        view.panX += (m.x - gesture.prevMidX);
        view.panY += (m.y - gesture.prevMidY);

        // zoom by distance ratio
        const ratio = d / Math.max(1, gesture.prevDist);
        const newZoom = Math.max(view.minZoom, Math.min(view.maxZoom, view.userZoom * ratio));
        view.userZoom = newZoom;

        // scaling about midpoint relative to viewport center keeps the content under fingers
        const newEff = effFit();
        const r = newEff / Math.max(0.0001, oldEff);
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;

        view.panX = r * view.panX + (1 - r) * (m.x - cx);
        view.panY = r * view.panY + (1 - r) * (m.y - cy);

        applyView();

        // update prevs
        gesture.prevMidX = m.x;
        gesture.prevMidY = m.y;
        gesture.prevDist = d;
        gesture.prevEff = newEff;

        e.preventDefault();
      }

      if(gesture.mode === 'pan' && pointers.size === 1){
        const only = [...pointers.values()][0];
        if(only.interactive) return;
        view.panX += (only.x - gesture.prevMidX);
        view.panY += (only.y - gesture.prevMidY);
        applyView();
        gesture.prevMidX = only.x;
        gesture.prevMidY = only.y;
        e.preventDefault();
      }
    }, { passive:false });

    function endPointer(id){
      pointers.delete(id);
      if(pointers.size < 2 && gesture && gesture.mode === 'pinch'){
        gesture = null;
      }
      if(pointers.size === 0){
        gesture = null;
      }
      // If one finger remains and it's non-interactive, allow pan continue
      if(pointers.size === 1){
        const only = [...pointers.values()][0];
        if(only && !only.interactive){
          gesture = { mode:'pan', prevMidX: only.x, prevMidY: only.y, prevEff: effFit() };
        }else{
          gesture = null;
        }
      }
    }

    center.addEventListener('pointerup', (e) => endPointer(e.pointerId), { passive:true });
    center.addEventListener('pointercancel', (e) => endPointer(e.pointerId), { passive:true });

          // already removed by pointerup handler order? (depends). We'll just check target.
      if(isInteractiveTarget(e.target)) return;
      if(e.pointerType !== 'touch') return;
      const now = performance.now();
      if(now - lastBgTap < 320){
        resetView();
        lastBgTap = 0;
      }else{
        lastBgTap = now;
      }
    }, { passive:true });

    // ===== Existing app logic (windows/icons) =====
    let zTop = 50;
    let frontWin = null;
    let activeMenu = null;

    function getFit(){ return effFit(); }
    function getScale(){ return parseFloat(getComputedStyle(ui).getPropertyValue('--scale')) || 1; }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function snap(n, step){ return Math.round(n / step) * step; }
    function stageRect(){ return stage.getBoundingClientRect(); }
    function uiRect(){ return ui.getBoundingClientRect(); }
    function desktopRect(){ return desktop.getBoundingClientRect(); }

    function addTapOpen(el, onOpen){
      let lastT = 0;
      el.addEventListener("pointerup", (e) => {
        if(e.pointerType !== "touch") return;
        const now = performance.now();
        if(now - lastT < 320){
          onOpen();
          lastT = 0;
        }else{
          lastT = now;
        }
      });
    }
    function addLongPressOpen(el, onOpen){
      let timer = null;
      el.addEventListener("pointerdown", (e) => {
        if(e.pointerType !== "touch") return;
        timer = setTimeout(() => { onOpen(); }, 450);
      });
      el.addEventListener("pointermove", () => { if(timer) clearTimeout(timer); timer=null; });
      el.addEventListener("pointerup",   () => { if(timer) clearTimeout(timer); timer=null; });
      el.addEventListener("pointercancel",() => { if(timer) clearTimeout(timer); timer=null; });
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    setInterval(() => {
      const d = new Date();
      $("#clock").textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }, 500);

    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "square"; o.frequency.value = 740;
        g.gain.value = 0.03;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(() => { o.stop(); ctx.close(); }, 90);
      }catch(e){}
    }

    function setFront(win){
      if(!win) return;
      $$(".window", ui).forEach(w => w.classList.add("inactive"));
      win.classList.remove("inactive");
      zTop += 1;
      win.style.zIndex = zTop;
      frontWin = win;
    }
    function showWin(id){
      const win = document.getElementById(id);
      if(!win) return;
      win.classList.add("visible");
      setFront(win);
    }
    function hideWin(id){
      const win = document.getElementById(id);
      if(!win) return;
      win.classList.remove("visible");
      if(frontWin === win) frontWin = null;
      const vis = $$(".window.visible", ui);
      if(vis.length) setFront(vis[vis.length-1]);
    }

    $$(".closebox", ui).forEach(btn => {
      btn.addEventListener("click", (e) => {
        const id = btn.getAttribute("data-close");
        if(id) hideWin(id);
        e.stopPropagation();
      });
    });

    $$(".window", ui).forEach(win => win.addEventListener("pointerdown", () => setFront(win)));

    let dragWin = null, resizeWin = null, dragIcon = null;
    const DRAG_START_PX = 6;

    function onPointerDownTitle(e){
      const win = e.currentTarget.closest(".window");
      if(e.target.closest(".closebox")) return;
      setFront(win);

      const fit = getFit();
      const ur = uiRect();
      const rect = win.getBoundingClientRect();

      dragWin = {
        win, pointerId: e.pointerId,
        startX: e.clientX, startY: e.clientY,
        origL: (rect.left - ur.left) / fit,
        origT: (rect.top  - ur.top ) / fit,
        fit, moved:false
      };
      win.setPointerCapture?.(e.pointerId);
      e.preventDefault(); e.stopPropagation();
    }
    $$(".window .titlebar", ui).forEach(tb => tb.addEventListener("pointerdown", onPointerDownTitle));

    function onPointerDownResize(e){
      const id = e.currentTarget.getAttribute("data-resize");
      const win = document.getElementById(id);
      if(!win) return;
      setFront(win);

      const fit = getFit();
      const ur = uiRect();
      const rect = win.getBoundingClientRect();

      resizeWin = {
        win, pointerId: e.pointerId,
        startX: e.clientX, startY: e.clientY,
        origW: rect.width / fit,
        origH: rect.height / fit,
        left: (rect.left - ur.left) / fit,
        top:  (rect.top  - ur.top ) / fit,
        fit
      };
      win.setPointerCapture?.(e.pointerId);
      e.preventDefault(); e.stopPropagation();
    }
    $$(".resize-handle", ui).forEach(h => h.addEventListener("pointerdown", onPointerDownResize));

    function clearIconSelection(){ $$(".icon", ui).forEach(i => i.classList.remove("selected")); }

    function onPointerDownIcon(e){
      const icon = e.currentTarget;
      clearIconSelection();
      icon.classList.add("selected");

      const fit = getFit();
      const dr = desktopRect();
      const rect = icon.getBoundingClientRect();

      dragIcon = {
        icon, pointerId: e.pointerId,
        startX: e.clientX, startY: e.clientY,
        origL: (rect.left - dr.left) / fit,
        origT: (rect.top  - dr.top ) / fit,
        fit, moved:false
      };
      icon.setPointerCapture?.(e.pointerId);
      e.preventDefault(); e.stopPropagation();
    }

    $$(".icon", ui).forEach(icon => {
      icon.addEventListener("pointerdown", onPointerDownIcon);
      icon.addEventListener("dblclick", () => { const open = icon.getAttribute("data-open"); if(open) openThing(open); });
      addTapOpen(icon, () => { const open = icon.getAttribute("data-open"); if(open) openThing(open); });
      addLongPressOpen(icon, () => { const open = icon.getAttribute("data-open"); if(open) openThing(open); });
    });

    desktop.addEventListener("pointerdown", (e) => {
      if(!e.target.closest(".icon") && !e.target.closest(".window")){
        clearIconSelection();
        closeMenus();
      }
    });

    window.addEventListener("pointermove", (e) => {
      if(resizeWin && e.pointerId === resizeWin.pointerId){
        const fit = resizeWin.fit;
        const dx = (e.clientX - resizeWin.startX) / fit;
        const dy = (e.clientY - resizeWin.startY) / fit;

        const ur = uiRect();
        const uw = ur.width / fit;
        const uh = ur.height / fit;

        const w = resizeWin.win;
        const minW = parseFloat(getComputedStyle(w).minWidth) || 240;
        const minH = parseFloat(getComputedStyle(w).minHeight) || 130;

        const scale = getScale();
        const step = Math.max(6, Math.round(8 * scale));

        const maxW = uw - resizeWin.left - 4;
        const maxH = uh - resizeWin.top - 4;

        let nw = clamp(resizeWin.origW + dx, minW, maxW);
        let nh = clamp(resizeWin.origH + dy, minH, maxH);

        nw = snap(nw, step); nh = snap(nh, step);

        w.style.width = nw + "px";
        w.style.height = nh + "px";
        return;
      }

      if(dragWin && e.pointerId === dragWin.pointerId){
        if(!dragWin.moved){
          const dist = Math.hypot(e.clientX - dragWin.startX, e.clientY - dragWin.startY);
          if(dist < DRAG_START_PX) return;
          dragWin.moved = true;
        }
        const fit = dragWin.fit;
        const dx = (e.clientX - dragWin.startX) / fit;
        const dy = (e.clientY - dragWin.startY) / fit;

        const w = dragWin.win;
        const ur = uiRect();
        const uw = ur.width / fit;
        const uh = ur.height / fit;

        const bw = w.offsetWidth;
        const bh = w.offsetHeight;

        const scale = getScale();
        const step = Math.max(6, Math.round(8 * scale));

        let left = snap(dragWin.origL + dx, step);
        let top  = snap(dragWin.origT + dy, step);

        left = clamp(left, 4, uw - bw - 4);
        top  = clamp(top, 4, uh - bh - 4);

        w.style.left = left + "px";
        w.style.top  = top + "px";
        return;
      }

      if(dragIcon && e.pointerId === dragIcon.pointerId){
        if(!dragIcon.moved){
          const dist = Math.hypot(e.clientX - dragIcon.startX, e.clientY - dragIcon.startY);
          if(dist < DRAG_START_PX) return;
          dragIcon.moved = true;
        }
        const fit = dragIcon.fit;
        const dx = (e.clientX - dragIcon.startX) / fit;
        const dy = (e.clientY - dragIcon.startY) / fit;

        const icon = dragIcon.icon;
        const dr = desktopRect();
        const dw = dr.width / fit;
        const dh = dr.height / fit;

        const scale = getScale();
        const step = Math.max(8, Math.round(10 * scale));

        const bw = icon.offsetWidth;
        const bh = icon.offsetHeight;

        let left = snap(dragIcon.origL + dx, step);
        let top  = snap(dragIcon.origT + dy, step);

        left = clamp(left, 6, dw - bw - 6);
        top  = clamp(top, 6, dh - bh - 6);

        icon.style.left = left + "px";
        icon.style.top  = top  + "px";
      }
    }, { passive:false });

    window.addEventListener("pointerup", (e) => {
      if(resizeWin && e.pointerId === resizeWin.pointerId) resizeWin = null;
      if(dragWin   && e.pointerId === dragWin.pointerId)   dragWin = null;
      if(dragIcon  && e.pointerId === dragIcon.pointerId)  dragIcon = null;
    }, { passive:true });

    window.addEventListener("pointercancel", (e) => {
      if(resizeWin && e.pointerId === resizeWin.pointerId) resizeWin = null;
      if(dragWin   && e.pointerId === dragWin.pointerId)   dragWin = null;
      if(dragIcon  && e.pointerId === dragIcon.pointerId)  dragIcon = null;
    }, { passive:true });

    $("#finderList").addEventListener("click", (e) => {
      const item = e.target.closest(".item");
      if(!item) return;
      const open = item.getAttribute("data-open");
      if(open) openThing(open);
    });

    function openThing(key){
      switch(key){
        case "finder": showWin("win-finder"); break;
        case "note": showWin("win-note"); setTimeout(()=>$("#noteArea")?.focus(), 50); break;
        case "calc": showWin("win-calc"); break;
        case "music": showWin("win-music"); break;
        case "about": showWin("win-about"); break;
        case "trash": showWin("win-trash"); break;
        default: beep();
      }
    }

    const menus = {
      apple: $("#dd-apple"),
      file: $("#dd-file"),
      edit: $("#dd-edit"),
      view: $("#dd-view"),
      special: $("#dd-special")
    };
    function closeMenus(){
      $$(".menu-item", ui).forEach(m => m.classList.remove("active"));
      Object.values(menus).forEach(dd => dd.style.display = "none");
      activeMenu = null;
      $("#appleBtn").style.background = "";
      $("#appleBtn").style.color = "";
    }
    function openMenu(name, anchorEl){
      closeMenus();
      activeMenu = name;
      if(anchorEl.classList.contains("menu-item")) anchorEl.classList.add("active");
      if(name === "apple"){ $("#appleBtn").style.background = "#000"; $("#appleBtn").style.color = "#fff"; }
      const dd = menus[name];
      if(!dd) return;
      const sr = stageRect();
      const r = anchorEl.getBoundingClientRect();
      const fit = getFit();
      dd.style.left = Math.max(6, (r.left - sr.left) / fit) + "px";
      dd.style.display = "block";
    }
    $("#appleBtn").addEventListener("click", (e) => {
      if(activeMenu === "apple"){ closeMenus(); return; }
      openMenu("apple", e.currentTarget);
      e.stopPropagation();
    });
    $$(".menu-item", ui).forEach(mi => {
      mi.addEventListener("click", (e) => {
        const name = mi.getAttribute("data-menu");
        if(activeMenu === name){ closeMenus(); return; }
        openMenu(name, mi);
        e.stopPropagation();
      });
    });
    ui.addEventListener("pointerdown", (e) => {
      if(e.target.closest(".dropdown") || e.target.closest(".menubar")) return;
      closeMenus();
    }, { passive:true });

    function alertBox(title, msg){
      $("#alertTitle").textContent = title;
      $("#alertMsg").textContent = msg;
      showWin("win-alert");
    }

    // Clean up desktop (kept)
    function cleanUpDesktop(){
      const fit = getFit();
      const dr = desktopRect();
      const dw = dr.width / fit;
      const dh = dr.height / fit;
      const scale = getScale();
      const icons = $$(".icon", ui);
      const trash = $("#icon-trash");
      icons.forEach(i => { i.style.right = "auto"; });

      const margin = Math.round(12 * scale);
      const colW   = Math.round(92 * scale);
      const rowH   = Math.round(96 * scale);
      const iconW  = Math.round(76 * scale);
      const iconH  = Math.round(80 * scale);

      if(trash){
        trash.style.left = (dw - iconW - margin) + "px";
        trash.style.top  = margin + "px";
      }
      let x = margin, y = margin;
      icons.filter(i => i !== trash).sort((a,b)=>a.id.localeCompare(b.id)).forEach(icon=>{
        icon.style.left = x + "px";
        icon.style.top  = y + "px";
        y += rowH;
        if(y + iconH > dh - margin){ y = margin; x += colW; }
        if(x + iconW > dw - margin){ x = margin; }
      });
      beep();
    }

    function applyAction(act){
      switch(act){
        case "about": showWin("win-about"); break;
        case "openFinder": showWin("win-finder"); break;
        case "openNote": showWin("win-note"); setTimeout(()=>$("#noteArea")?.focus(), 50); break;
        case "openCalc": showWin("win-calc"); break;
        case "openMusic": showWin("win-music"); break;
        case "cleanup": cleanUpDesktop(); break;

        case "scaleNormal": document.body.classList.remove("big","huge"); break;
        case "scaleBig": document.body.classList.remove("huge"); document.body.classList.add("big"); break;
        case "scaleHuge": document.body.classList.remove("big"); document.body.classList.add("huge"); break;

        default: beep();
      }
    }
    $$(".dropdown", ui).forEach(dd => {
      dd.addEventListener("click", (e) => {
        const row = e.target.closest(".row");
        if(!row) return;
        const act = row.getAttribute("data-action");
        if(act && act !== "sep"){
          applyAction(act);
          closeMenus();
        }
      });
    });

    // Calculator (simple)
    const calcDisplay = $("#calcDisplay");
    let calcState = { display: "0", first: null, op: null, waiting: false };
    function calcRender(){ const s = calcState.display; calcDisplay.textContent = (s.length > 14) ? s.slice(0, 14) : s; }
    function calcClear(){ calcState = { display:"0", first:null, op:null, waiting:false }; calcRender(); }
    function calcInputDigit(d){ if(calcState.waiting){ calcState.display = d; calcState.waiting=false; } else calcState.display = (calcState.display==="0")?d:(calcState.display+d); calcRender(); }
    function calcInputDot(){ if(calcState.waiting){ calcState.display="0."; calcState.waiting=false; calcRender(); return;} if(!calcState.display.includes(".")){ calcState.display+="."; calcRender(); } }
    function calcCompute(a,b,op){ if(op==="+") return a+b; if(op==="-") return a-b; if(op==="*") return a*b; if(op==="/") return (b===0)?NaN:(a/b); return b; }
    function calcOperator(nextOp){
      const input = parseFloat(calcState.display);
      if(calcState.first == null) calcState.first = input;
      else if(calcState.op && !calcState.waiting){
        const result = calcCompute(calcState.first, input, calcState.op);
        calcState.first = result;
        calcState.display = Number.isFinite(result) ? String(result) : "Error";
      }
      calcState.op = nextOp; calcState.waiting = true; calcRender();
    }
    function calcEquals(){
      const input = parseFloat(calcState.display);
      if(calcState.op==null || calcState.first==null || calcState.waiting) return;
      const result = calcCompute(calcState.first, input, calcState.op);
      calcState.display = Number.isFinite(result) ? String(result) : "Error";
      calcState.first=null; calcState.op=null; calcState.waiting=true; calcRender();
    }
    function calcPress(k){
      if(k>="0" && k<="9") return calcInputDigit(k);
      if(k===".") return calcInputDot();
      if(k==="C") return calcClear();
      if(k==="+"||k==="-"||k==="*"||k==="/") return calcOperator(k);
      if(k==="=") return calcEquals();
    }
    $("#win-calc").addEventListener("click", (e)=>{ const b=e.target.closest(".key"); if(!b) return; const k=b.getAttribute("data-k"); if(k==="BS") return; if(k==="%") return; if(k) calcPress(k.replace("÷","/").replace("×","*")); });
    calcRender();

    // Music
    const music = {
      audio: new Audio("song.mp3"),
      seek: $("#musicSeek"),
      state: $("#musicState"),
      time: $("#musicTime"),
      dur: $("#musicDur"),
      status: $("#musicStatus"),
      seeking:false
    };
    music.audio.preload = "metadata";
    function fmtTime(sec){
      if(!Number.isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec/60), s=Math.floor(sec%60);
      return `${m}:${String(s).padStart(2,"0")}`;
    }
    function syncMusic(){
      const a=music.audio;
      const d=Number.isFinite(a.duration)?a.duration:0;
      if(!music.seeking){
        music.seek.max=String(d||0);
        music.seek.value=String(a.currentTime||0);
      }
      music.time.textContent=fmtTime(a.currentTime||0);
      music.dur.textContent=fmtTime(d||0);
      music.state.textContent=a.paused?"STOP":"PLAY";
    }
    music.audio.addEventListener("loadedmetadata", ()=>{ music.status.textContent="Loaded"; syncMusic(); });
    music.audio.addEventListener("timeupdate", syncMusic);
    music.audio.addEventListener("play", ()=>{ music.status.textContent="Playing"; syncMusic(); });
    music.audio.addEventListener("pause", ()=>{ music.status.textContent="Paused"; syncMusic(); });
    music.audio.addEventListener("error", ()=>{ music.status.textContent="Cannot load song.mp3"; alertBox("Music Player","无法加载 song.mp3，请确认同目录。"); });

    document.getElementById("musicPlay").addEventListener("click", async ()=>{
      try{ await music.audio.play(); }catch(e){ alertBox("Music Player","浏览器阻止播放：请再点一次 Play。"); }
    });
    document.getElementById("musicPause").addEventListener("click", ()=>music.audio.pause());
    music.seek.addEventListener("input", ()=>{ music.seeking=true; const t=parseFloat(music.seek.value); if(Number.isFinite(t)) music.audio.currentTime=t; syncMusic(); });
    music.seek.addEventListener("change", ()=>{ music.seeking=false; syncMusic(); });

    // Init
    resetView();
    showWin("win-finder"); setFront(document.getElementById("win-finder"));
    syncMusic();
  </script>
</body>
</html>
